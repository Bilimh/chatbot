
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chatbot Orientation ‚Äî Lyc√©e Aim√© C√©saire</title>
  <style>
    :root{
      --bg: #0b1020;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --accent: #7c3aed;
      --accent2:#22c55e;
      --danger:#ef4444;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius: 18px;
    }

    *{box-sizing:border-box}
    html,body{
      height:100vh; 
      margin:0; 
      padding:0;
      overflow: hidden; /* Emp√™che le scroll global */
    }
    
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(124,58,237,.35), transparent 60%),
        radial-gradient(900px 600px at 90% 30%, rgba(34,197,94,.25), transparent 55%),
        radial-gradient(800px 700px at 40% 90%, rgba(59,130,246,.20), transparent 55%),
        linear-gradient(180deg, #070a14, #0b1020 60%, #070a14);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }

    .app{
      width:min(980px, 100%);
      height:min(760px, 95vh);
      border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border-radius:26px;
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      position: relative;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:16px 18px;
      border-bottom:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
      background: rgba(10,14,28,.55);
      flex-shrink: 0;
      z-index: 10;
    }
    
    .brand{
      display:flex; gap:12px; align-items:center;
      min-width: 0;
    }
    
    .logo{
      width:40px; height:40px; border-radius:14px;
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.45), transparent 60%),
        linear-gradient(135deg, rgba(124,58,237,.95), rgba(34,197,94,.8));
      box-shadow: 0 10px 30px rgba(124,58,237,.22);
      flex:0 0 auto;
    }
    
    .title{
      display:flex; flex-direction:column; line-height:1.1;
      min-width:0;
    }
    
    .title strong{
      font-size:14px;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    
    .title span{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .header-actions{
      display:flex; gap:10px; align-items:center;
    }
    
    .chip{
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color: var(--muted);
    }
    
    .btn{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
      font-weight:600;
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    
    .btn:hover{ background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.20); }
    .btn:active{ transform: translateY(1px); }
    
    .btn.primary{
      border-color: rgba(124,58,237,.55);
      background: rgba(124,58,237,.20);
    }

    main{
      flex: 1 1 auto;
      overflow-y: auto;
      overflow-x: hidden;
      scroll-behavior:smooth;
      padding:18px;
      -webkit-overflow-scrolling: touch; /* Scroll fluide sur iOS */
    }

    .messages{
      display:flex;
      flex-direction:column;
      gap:12px;
      max-width: 820px;
      margin:0 auto;
      padding-bottom: 10px;
    }

    .row{
      display:flex;
      gap:10px;
      align-items:flex-end;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .row.bot{ justify-content:flex-start; }
    .row.user{ justify-content:flex-end; }

    .avatar{
      width:34px; height:34px; border-radius: 12px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      display:flex; align-items:center; justify-content:center;
      font-size:16px;
      flex:0 0 auto;
    }
    
    .bubble{
      max-width: 92vw;
      padding:12px 14px;
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      box-shadow: 0 10px 26px rgba(0,0,0,.16);
      line-height:1.45;
      font-size:14px;
      white-space:pre-wrap;
      word-break: break-word;
    }
    
    .row.user .bubble{
      background: linear-gradient(135deg, rgba(124,58,237,.30), rgba(124,58,237,.16));
      border-color: rgba(124,58,237,.45);
    }
    
    .meta{
      font-size:11px;
      color: rgba(255,255,255,.55);
      margin: 0 6px;
      white-space: nowrap;
    }

    .cards{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      margin-top:10px;
    }
    
    @media (min-width:640px){
      .cards{ grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
    }

    .card{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      border-radius: 18px;
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:10px;
      transition: transform 0.2s ease, border-color 0.2s ease;
    }
    
    .card:hover {
      border-color: rgba(124,58,237,.4);
      transform: translateY(-2px);
    }
    
    .card h3{
      margin:0;
      font-size:15px;
      letter-spacing:.2px;
      font-weight:700;
    }
    
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      width: fit-content;
      color: var(--muted);
    }
    
    .card p{
      margin:0;
      color: var(--muted);
      font-size:13px;
      line-height:1.45;
    }
    
    .card .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:4px;
    }
    
    .link{
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight:600;
      font-size:12px;
      transition: all 0.2s ease;
    }
    
    .link:hover{
      background: rgba(255,255,255,.12);
      border-color: rgba(255,255,255,.25);
    }
    
    .link.green{
      border-color: rgba(34,197,94,.5);
      background: rgba(34,197,94,.14);
    }
    
    .link.green:hover {
      background: rgba(34,197,94,.25);
    }

    footer{
      border-top:1px solid rgba(255,255,255,.10);
      background: rgba(10,14,28,.85);
      backdrop-filter: blur(10px);
      padding:14px 16px;
      display:flex;
      flex-direction:column;
      gap:12px;
      flex-shrink: 0;
      position: relative;
      z-index: 10;
    }

    .quick-replies{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      max-width: 860px;
      margin:0 auto;
      justify-content:center;
    }
    
    .qr{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:10px 14px;
      border-radius: 999px;
      font-weight:600;
      font-size:13px;
      transition: all .15s ease;
      user-select:none;
    }
    
    .qr:hover{ 
      background: rgba(255,255,255,.12); 
      border-color: rgba(255,255,255,.25);
      transform: translateY(-1px);
    }
    
    .qr:active{ transform: translateY(1px); }
    
    .qr.accent{ 
      border-color: rgba(124,58,237,.55); 
      background: rgba(124,58,237,.2); 
    }
    
    .qr.accent:hover {
      background: rgba(124,58,237,.3);
    }
    
    .qr.good{ 
      border-color: rgba(34,197,94,.55); 
      background: rgba(34,197,94,.14); 
    }
    
    .qr.good:hover {
      background: rgba(34,197,94,.25);
    }
    
    .qr.warn{ 
      border-color: rgba(239,68,68,.55); 
      background: rgba(239,68,68,.12); 
    }
    
    .qr.warn:hover {
      background: rgba(239,68,68,.22);
    }

    /* ‚úÖ STYLE POUR LE CHAMP DE TEXTE - TOUJOURS VISIBLE */
    .text-input-container {
      display: flex;
      padding: 8px 0 4px 0;
      gap: 10px;
      width: 100%;
      box-sizing: border-box;
      flex-shrink: 0;
      background: transparent;
    }

    .text-input-container input {
      flex: 1;
      padding: 14px 18px;
      border-radius: 30px;
      border: 1px solid rgba(255,255,255,.2);
      background: rgba(20,25,35,.95);
      color: white;
      font-size: 16px; /* √âvite le zoom automatique sur iOS */
      outline: none;
      transition: all 0.2s ease;
      -webkit-appearance: none;
    }

    .text-input-container input:focus {
      border-color: var(--accent);
      background: rgba(30,35,45,.98);
      box-shadow: 0 0 0 3px rgba(124,58,237,.2);
    }

    .text-input-container input::placeholder {
      color: rgba(255,255,255,.5);
      font-size: 14px;
    }

    .text-input-container button {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, var(--accent), #9f67ff);
      color: white;
      font-size: 22px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(124,58,237,.3);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      padding: 0;
    }

    .text-input-container button:hover {
      background: linear-gradient(135deg, #8b5cf6, #a78bfa);
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(124,58,237,.4);
    }

    .text-input-container button:active {
      transform: translateY(1px);
      box-shadow: 0 2px 8px rgba(124,58,237,.3);
    }

    .small{
      text-align:center;
      color: rgba(255,255,255,.60);
      font-size:11px;
      letter-spacing: 0.3px;
    }

    /* typing indicator */
    .typing{
      display:inline-flex;
      gap:6px;
      align-items:center;
    }
    
    .dot{
      width:7px;height:7px;border-radius:50%;
      background: rgba(255,255,255,.65);
      animation: bounce 1s infinite ease-in-out;
    }
    
    .dot:nth-child(2){ animation-delay: .15s; }
    .dot:nth-child(3){ animation-delay: .30s; }
    
    @keyframes bounce{
      0%,80%,100%{ transform: translateY(0); opacity:.6;}
      40%{ transform: translateY(-6px); opacity:1;}
    }
    
    a {
      text-decoration: none;
      display: inline-block;
      color: white;
      margin-bottom: 5px;
      font-size: 18px;
    }

    /* Scrollbar personnalis√©e */
    ::-webkit-scrollbar {
      width: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(255,255,255,.03);
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,.15);
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,.25);
    }

    /* ‚úÖ RESPONSIVE SP√âCIAL T√âL√âPHONE */
    @media (max-width: 600px) {
      body { 
        padding: 0; 
      }
      
      .app {
        height: 100vh; /* Pleine hauteur */
        width: 100%;
        border-radius: 0;
        max-height: 100vh;
      }
      
      .bubble {
        max-width: 85%;
        font-size: 15px;
      }
      
      .quick-replies {
        gap: 8px;
      }
      
      .qr {
        padding: 8px 14px;
        font-size: 12px;
      }
      
      .text-input-container {
        padding: 8px 0 4px 0;
      }
      
      .text-input-container input {
        padding: 12px 16px;
        font-size: 16px; /* Emp√™che le zoom sur iPhone */
      }
      
      .text-input-container button {
        width: 48px;
        height: 48px;
        font-size: 20px;
      }
      
      header {
        padding: 12px 16px;
      }
      
      main {
        padding: 16px;
      }
      
      .chip { 
        display: none; 
      }
    }
    /* ‚úÖ SOLUTION FINALE RECOMMAND√âE */
html {
  scroll-padding-top: 70px; /* ‚Üê D√©cale le scroll pour √©viter que les messages soient cach√©s */
}

main{
  flex: 1 1 auto;
  overflow-y: auto;
  overflow-x: hidden;
  scroll-behavior:smooth;
  padding: 18px;
  -webkit-overflow-scrolling: touch;
  /* Pas de padding-top fixe, on utilise scroll-padding √† la place */
}

header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:16px 18px;
  border-bottom:1px solid rgba(255,255,255,.10);
  backdrop-filter: blur(10px);
  background: rgba(10,14,28,.55);
  flex-shrink: 0;
  z-index: 10;
  position: sticky; /* ‚Üê Header sticky */
  top: 0;
}

footer{
  border-top:1px solid rgba(255,255,255,.10);
  background: rgba(10,14,28,.85);
  backdrop-filter: blur(10px);
  padding:14px 16px;
  display:flex;
  flex-direction:column;
  gap:12px;
  flex-shrink: 0;
  position: sticky; /* ‚Üê Footer sticky en bas */
  bottom: 0;
  z-index: 10;
}

@media (max-width: 600px) {
  body { padding: 0; }
  
  .app {
    height: 100vh;
    width: 100%;
    border-radius: 0;
    max-height: 100vh;
  }
  
  /* Ajuster scroll-padding pour mobile */
  html {
    scroll-padding-top: 60px;
  }
  
  header {
    padding: 12px 16px;
  }
  
  .bubble {
    max-width: 85%;
    font-size: 15px;
  }
  
  .text-input-container input {
    padding: 12px 16px;
    font-size: 16px;
  }
  
  .text-input-container button {
    width: 48px;
    height: 48px;
    font-size: 20px;
  }
  
  .chip { display: none; }
}
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Chatbot orientation">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <strong> <a href="./index.html">Chatbot Orientation ‚Äî Lyc√©e Pro Aim√© C√©saire</a> </strong>
          <span>D√©couvrir les m√©tiers et formations en 2 minutes</span>
        </div>
      </div>
      <div class="header-actions">
        <span class="chip" id="statusChip">Pr√™t</span>
        <button class="btn" id="btnRestart" title="Recommencer">‚Ü∫ Recommencer</button>
        <button class="btn primary" id="btnDemo" title="Mode d√©mo (auto)">‚ñ∂ D√©mo</button>
      </div>
    </header>

    <main id="main">
      <div class="messages" id="messages"></div>
    </main>

    <footer>
      <div class="quick-replies" id="quickReplies"></div>
      <!-- L'input sera ajout√© ici automatiquement par JavaScript -->
    </footer>
  </div>
<script>
    /* =========================
   0) S√©lecteurs DOM attendus
   =========================
   Le HTML doit contenir :
   - #messages
   - #quickReplies
   - #main
   - #statusChip
   - #btnRestart
   - #btnDemo
*/
const messagesEl = document.getElementById("messages");
const quickRepliesEl = document.getElementById("quickReplies");
const mainEl = document.getElementById("main");
const statusChip = document.getElementById("statusChip");
const btnRestart = document.getElementById("btnRestart");
const btnDemo = document.getElementById("btnDemo");

/* =========================
   1) CONTENU : formations
   ========================= */
const PROGRAMS = {
  // ===== Initiale =====
  cap_elec: {
    title: "CAP √âlectricien / √âlectricienne",
    badge: "‚ö° Initiale ‚Äî √âlectricit√©",
    pitch: "Installer, mettre en service, entretenir et d√©panner des installations √©lectriques (b√¢timent, industrie, services‚Ä¶).",
    jobs: ["√âlectricien(ne) installateur(trice)"],
    next: "Poursuite possible : Bac Pro MELEC, BP‚Ä¶",
    pageUrl: "https://example.com/page-cap-electricien",
    mode: "initiale",
    family: "elec",
  },
  bac_melec: {
    title: "Bac Pro MELEC (M√©tiers de l'√©lectricit√© et de ses environnements connect√©s)",
    badge: "üîå Initiale ‚Äî MELEC",
    pitch: "R√©aliser et maintenir des √©quipements √©lectriques, parfois connect√©s (domotique, r√©seaux, b√¢timent‚Ä¶).",
    jobs: ["Technicien(ne) √©lectricien(ne)", "Installateur(trice) domotique (selon parcours)"],
    next: "BTS / sp√©cialisation selon projet.",
    pageUrl: "https://example.com/page-bac-melec",
    mode: "initiale",
    family: "elec",
  },
  cap_metallier: {
    title: "CAP M√©tallier / M√©talli√®re",
    badge: "üß± Initiale ‚Äî M√©tallerie",
    pitch: "Fabriquer et poser des √©l√©ments m√©talliques : garde-corps, portails, structures (atelier + chantier).",
    jobs: ["M√©tallier(√®re)", "Serrurier(√®re)"],
    next: "Poursuite possible : Bac Pro M√©tallerie, BP‚Ä¶",
    pageUrl: "https://example.com/page-cap-metallier",
    mode: "initiale",
    family: "metal",
  },
  bac_metallerie: {
    title: "Bac Pro Ouvrages du B√¢timent : M√©tallerie",
    badge: "üèóÔ∏è Initiale ‚Äî B√¢timent & M√©tal",
    pitch: "Pr√©parer, r√©aliser et poser des ouvrages m√©talliques plus complexes (plans, mesures, assemblage).",
    jobs: ["M√©tallier(√®re)", "Monteur(se) en ouvrages m√©talliques"],
    next: "BTS / insertion pro.",
    pageUrl: "https://example.com/page-bac-metallerie",
    mode: "initiale",
    family: "metal",
  },
  cap_epc: {
    title: "CAP √âquipier / √âquipi√®re Polyvalent(e) du Commerce",
    badge: "üõçÔ∏è Initiale ‚Äî Commerce",
    pitch: "Mettre en rayon, g√©rer les stocks, accueillir et renseigner les clients en magasin.",
    jobs: ["Employ√©(e) de commerce", "√âquipier(√®re) polyvalent(e)"],
    next: "Poursuite possible : Bac Pro M√©tiers du Commerce et de la Vente‚Ä¶",
    pageUrl: "https://example.com/page-cap-epc",
    mode: "initiale",
    family: "commerce",
  },
  seconde_mrc: {
    title: "2nde Bac Pro M√©tiers de la Relation Client√®le (MRC)",
    badge: "üß≠ Initiale ‚Äî Seconde MRC",
    pitch: "Ann√©e de d√©couverte et consolidation autour de la relation client (accueil, vente, communication).",
    jobs: ["‚Äî (ann√©e d'orientation vers Bac Pro)"],
    next: "Bac Pro Commerce/Vente / M√©tiers de l'accueil (selon √©tablissement).",
    pageUrl: "https://example.com/page-2nde-mrc",
    mode: "initiale",
    family: "commerce",
  },
  bac_commerce_vente: {
    title: "Bac Pro M√©tiers du Commerce et de la Vente",
    badge: "üí¨ Initiale ‚Äî Vente & Conseil",
    pitch: "Conseiller, vendre, fid√©liser, organiser un espace de vente et suivre des objectifs.",
    jobs: ["Vendeur(se) conseil", "Conseiller(√®re) client√®le"],
    next: "BTS MCO / NDRC (selon projet).",
    pageUrl: "https://example.com/page-bac-commerce-vente",
    mode: "initiale",
    family: "commerce",
  },
  bac_agora: {
    title: "Bac Pro AGOrA (Assistance √† la Gestion des Organisations et de leurs Activit√©s)",
    badge: "üìÅ Initiale ‚Äî Gestion",
    pitch: "En 2nde GATL (Gestion, Administration, Transport, Logistique), tu apprends les bases de la gestion administrative avant de te sp√©cialiser en Bac Pro AGOrA.",
    jobs: ["Assistant(e) de gestion", "Employ√©(e) administratif(ve)"],
    next: "BTS GPME / insertion pro.",
    pageUrl: "https://lp-aime-cesaire-lille.59.ac-lille.fr/bac-pro-gestion-administration-transport-logistique/",
    mode: "initiale",
    family: "tertiaire",
  },
  bac_accueil: {
    title: "Bac Pro M√©tiers de l'Accueil",
    badge: "üôÇ Initiale ‚Äî Accueil",
    pitch: "Accueillir, informer, orienter et g√©rer des situations usagers/clients en face √† face ou √† distance.",
    jobs: ["Agent d'accueil", "Charg√©(e) d'accueil"],
    next: "BTS / insertion pro.",
    pageUrl: "https://example.com/page-bac-accueil",
    mode: "initiale",
    family: "tertiaire",
  },

  // ===== Alternance =====
  alt_commerce: {
    title: "Les m√©tiers du Commerce (Alternance)",
    badge: "üîÑ Alternance ‚Äî Commerce",
    pitch: "Tu apprends en alternant lyc√©e et entreprise : pratique en magasin + cours au lyc√©e.",
    jobs: ["Employ√©(e) de commerce", "Vendeur(se) (selon parcours)"],
    next: "Objectif : exp√©rience + comp√©tences + insertion.",
    pageUrl: "https://example.com/page-alt-commerce",
    mode: "alternance",
    family: "commerce",
  },
  alt_elec: {
    title: "Les m√©tiers de l'√âlectricit√© (Alternance)",
    badge: "üîÑ Alternance ‚Äî √âlectricit√©",
    pitch: "Tu apprends en alternant lyc√©e et entreprise : chantiers/ateliers + cours au lyc√©e.",
    jobs: ["√âlectricien(ne) installateur(trice)", "Technicien(ne) √©lectricien(ne)"],
    next: "Objectif : exp√©rience + comp√©tences + insertion.",
    pageUrl: "https://example.com/page-alt-elec",
    mode: "alternance",
    family: "elec",
  },
  alt_metallerie: {
    title: "Les m√©tiers de la M√©tallerie (Alternance)",
    badge: "üîÑ Alternance ‚Äî M√©tallerie",
    pitch: "Tu apprends en alternant lyc√©e et entreprise : atelier/chantier + cours au lyc√©e.",
    jobs: ["M√©tallier(√®re)", "Serrurier(√®re)"],
    next: "Objectif : exp√©rience + comp√©tences + insertion.",
    pageUrl: "https://example.com/page-alt-metallerie",
    mode: "alternance",
    family: "metal",
  },
};

/* =========================
   2) Texte "C'est quoi l'alternance ?"
   ========================= */
const ALTERNANCE_EXPLAIN = [
  "üîÑ L'alternance, c'est apprendre un m√©tier en travaillant.",
  "",
  "üëâ Une partie du temps au lyc√©e",
  "üëâ Une partie du temps en entreprise",
  "",
  "‚úÖ Tu apprends sur le terrain",
  "‚úÖ Tu gagnes de l'exp√©rience",
  "‚úÖ Tu peux √™tre r√©mun√©r√©(e) selon le contrat",
].join("\n");

/* =========================
   3) MOTS-CL√âS ET R√âPONSES VARI√âES (CORRIG√â)
   ========================= */
const KEYWORDS = {
  // Salutations
  salut: { 
    replies: [
      "Salut üëã Bienvenue au lyc√©e Aim√© C√©saire !",
      "Bonjour ! Je suis l√† pour t'orienter üòä",
      "Hey ! Pr√™t(e) √† d√©couvrir nos formations ?",
      "Salut ! Je suis le chatbot d'orientation du lyc√©e."
    ],
    next: "start",
    isGreeting: true 
  },
  bonjour: { 
    replies: [
      "Bonjour ! Bienvenue au lyc√©e Aim√© C√©saire üëã",
      "Bonjour ! Tu cherches une formation ?",
      "Salut ! Je suis l√† pour t'aider √† t'orienter."
    ], 
    next: "start",
    isGreeting: true 
  },
  hello: { 
    replies: [
      "Hello ! Welcome to Aim√© C√©saire high school üëã",
      "Hi there ! How can I help you ?",
    ], 
    next: "start",
    isGreeting: true 
  },

  // √âLECTRICIT√â
  electricite: { 
    replies: [
      "üîå L'√©lectricit√©, bon choix ! On propose un CAP (2 ans) et un Bac Pro MELEC (3 ans). Tu pr√©f√®res lequel ?",
      "‚ö° G√©nial ! En √©lectricit√©, tu as le CAP pour entrer vite dans le m√©tier, ou le Bac Pro pour aller plus loin.",
      "üîß L'√©lectricit√© t'int√©resse ? CAP ou Bac Pro ?",
      "üí° L'√©lectricit√©, un secteur qui recrute ! Formation courte ou longue ?"
    ],
    next: "elec_choice"
  },
  elec: { 
    replies: [
      "üîå L'√©lectricit√©, top ! CAP ou Bac Pro ?",
      "‚ö° Tu veux en savoir plus sur l'√©lectricit√© ? CAP ou Bac Pro ?"
    ],
    next: "elec_choice" 
  },

  // M√âTALLERIE
  metallerie: { 
    replies: [
      "üß± La m√©tallerie, super choix ! CAP (2 ans) ou Bac Pro (3 ans) ?",
      "üèóÔ∏è La m√©tallerie, c'est pr√©cis et cr√©atif. Tu pr√©f√®res le CAP pratique ou le Bac Pro ?",
      "üî® M√©tallerie : CAP pour les bases, Bac Pro pour ma√Ætriser les plans complexes.",
      "‚öôÔ∏è Un m√©tier d'art ! Formation courte ou approfondie ?"
    ],
    next: "metal_choice" 
  },
  metal: { 
    replies: [
      "üß± M√©tallerie ! CAP ou Bac Pro ?",
      "üî® Tu veux d√©couvrir la m√©tallerie ? CAP ou Bac Pro ?"
    ],
    next: "metal_choice" 
  },

  // COMMERCE
  commerce: { 
    replies: [
      "üõçÔ∏è Le commerce, excellent ! CAP, 2nde MRC ou Bac Pro Vente ?",
      "üí¨ Tu veux travailler dans la vente ? On a trois parcours : CAP (2 ans), 2nde MRC (d√©couverte) ou Bac Pro (3 ans).",
      "üß∫ Commerce : CAP √âquipier, 2nde MRC ou Bac Pro Commerce/Vente ?",
      "üõí Formation rapide, d√©couverte ou approfondie ?"
    ],
    next: "commerce_choice" 
  },
  vente: { 
    replies: [
      "üí¨ La vente, super ! CAP, 2nde MRC ou Bac Pro ?",
      "üõçÔ∏è Tu veux faire de la vente ? CAP, 2nde ou Bac Pro ?"
    ],
    next: "commerce_choice" 
  },

  // GESTION
  gestion: { 
    replies: [
      "üìÅ La gestion administrative, parfait ! Bac Pro AGOrA en 3 ans, avec une 2nde GATL pour d√©marrer.",
      "üóÇÔ∏è Gestion/administration : le Bac Pro AGOrA forme aux m√©tiers d'assistant(e). 2nde GATL puis sp√©cialisation.",
      "üìä Tu veux travailler dans l'administration ? Bac Pro AGOrA, formation compl√®te !",
      "üìã Assistant de gestion, √ßa te parle ? Bac Pro AGOrA au lyc√©e !"
    ],
    next: "result_bac_agora" 
  },
  agora: { 
    replies: [
      "üìÅ Bac Pro AGOrA : gestion, administration, organisation. Tu commences en 2nde GATL !",
      "üìä AGOrA, excellent choix ! Formation compl√®te en gestion d'entreprise."
    ],
    next: "result_bac_agora" 
  },
  gatll: { 
    replies: [
      "üìÅ 2nde GATL : la porte d'entr√©e vers le Bac Pro AGOrA !",
      "üéØ 2nde GATL = d√©couverte de la gestion, administration, transport et logistique."
    ],
    next: "result_bac_agora" 
  },

  // ACCUEIL
  accueil: { 
    replies: [
      "üôÇ L'accueil, un m√©tier de contact ! Bac Pro M√©tiers de l'Accueil en 3 ans.",
      "üëã Accueil relation client : formation compl√®te pour devenir agent d'accueil.",
      "üòä Tu as le contact ? Le Bac Pro Accueil est fait pour toi !",
      "üìû Accueil physique et t√©l√©phonique, un Bac Pro qui m√®ne √† l'emploi."
    ],
    next: "result_bac_accueil" 
  },

  // ALTERNANCE
  alternance: { 
    replies: [
      "üîÑ L'alternance, c'est apprendre en entreprise ! On propose √ßa en √©lectricit√©, m√©tallerie et commerce.",
      "üíº Alternance = 2 jours au lyc√©e, 3 jours en entreprise. Quel secteur ?",
      "üìÖ L'alternance te tente ? √âlectricit√©, m√©tallerie ou commerce ?",
      "üîÅ Formation en alternance : exp√©rience garantie ! √âlec, m√©tal ou commerce ?"
    ],
    next: "alternance_choice" 
  },

  // CAP - GARDER LE CONTEXTE
  cap_elec: {
    replies: [
      "üéì CAP √âlectricien, excellent choix ! Formation en 2 ans pour devenir √©lectricien(ne) installateur(trice).",
      "‚úÖ Le CAP √âlectricien, c'est concret ! Tu seras op√©rationnel(le) rapidement."
    ],
    next: "result_cap_elec"
  },
  cap_metal: {
    replies: [
      "üéì CAP M√©tallier, super ! Formation en 2 ans pour ma√Ætriser les bases du m√©tier.",
      "‚úÖ Le CAP M√©tallier, c'est pratique et pr√©cis ! Tu apprendras √† fabriquer garde-corps, portails..."
    ],
    next: "result_cap_metallier"
  },
  cap_commerce: {
    replies: [
      "üéì CAP √âquipier Polyvalent du Commerce, parfait ! Formation en 2 ans pour travailler en magasin.",
      "‚úÖ Le CAP Commerce, c'est la voie rapide pour devenir employ√©(e) de commerce."
    ],
    next: "result_cap_epc"
  },

  // BAC PRO - GARDER LE CONTEXTE
  bac_elec: {
    replies: [
      "üìà Bac Pro MELEC, top ! Formation en 3 ans pour devenir technicien(ne) √©lectricien(ne).",
      "üéØ Le Bac Pro √âlectricit√©, c'est plus complet ! Tu pourras √©voluer vers des postes √† responsabilit√©s."
    ],
    next: "result_bac_melec"
  },
  bac_metal: {
    replies: [
      "üìà Bac Pro M√©tallerie, excellent ! Formation en 3 ans pour ma√Ætriser les ouvrages complexes.",
      "üéØ Le Bac Pro M√©tallerie ouvre plus de portes ! BTS possible apr√®s."
    ],
    next: "result_bac_metallerie"
  },
  bac_commerce: {
    replies: [
      "üìà Bac Pro Commerce/Vente, super ! Formation en 3 ans pour devenir vendeur(se) conseil.",
      "üéØ Le Bac Pro Commerce, c'est la voie pour √©voluer vers des postes de management."
    ],
    next: "result_bac_commerce_vente"
  },

  // R√âPONSES SP√âCIFIQUES
  cap: { 
    replies: [], // Ne plus utiliser, g√©r√© par les contextes sp√©cifiques
    next: null 
  },
  bacpro: { 
    replies: [], // Ne plus utiliser, g√©r√© par les contextes sp√©cifiques
    next: null 
  },

  // Remerciements
  merci: { 
    replies: [
      "Avec plaisir ! üëã",
      "De rien ! Reviens quand tu veux üòä",
      "Service ! N'h√©site pas √† recommencer üöÄ",
      "üòÑ Contente d'avoir pu t'aider !",
      "üëç Bonne continuation !"
    ],
    next: null 
  },

  // Au revoir
  aurevoir: { 
    replies: [
      "√Ä bient√¥t ! üëã",
      "Salut ! Bonne continuation üöÄ",
      "Bye ! Reviens tester d'autres formations üòä",
      "üëã N'h√©site pas √† revenir !",
      "Bonne journ√©e !"
    ],
    next: null 
  },

  // Aide
  aide: {
    replies: [
      "ü§ñ Je suis l√† pour t'orienter ! Tu peux me parler d'√©lectricit√©, m√©tallerie, commerce, gestion, accueil ou alternance.",
      "üí° √âcris un m√©tier ou une formation : CAP √©lectricien, Bac Pro commerce, alternance...",
      "üîç Tu cherches quoi ? √âlectricit√©, m√©tallerie, commerce, gestion, accueil ?"
    ],
    next: "start"
  }
};

/* =========================
   4) ARBRE PRINCIPAL (FLOW)
   ========================= */
/* =========================
   4) ARBRE PRINCIPAL (FLOW) - CORRIG√â
   ========================= */
const FLOW = {
  start: {
    bot: [
      "Salut üëã Je suis le chatbot d'orientation du lyc√©e Aim√© C√©saire.\nJe suis con√ßu par les √©l√®ves du lyc√©e, pour les futurs √©l√®ves du lyc√©e.\n\nEn quelques clics, je t'aide √† d√©couvrir une formation et un m√©tier.\nPr√™t(e) ? üöÄ\n\nTu t'int√©resses plut√¥t √† :",
      "Bonjour ! üëã Je suis le chatbot du lyc√©e Aim√© C√©saire.\nJe suis l√† pour t'aider √† trouver la formation qui te correspond.\n\nTu veux d√©couvrir l'√©lectricit√©, la m√©tallerie, le commerce, la gestion ou l'accueil ?",
      "Salut ! ü§ñ\nBienvenue au lyc√©e Aim√© C√©saire.\n\nDis-moi ce qui t'int√©resse : √©lectricit√©, m√©tallerie, commerce, gestion, accueil...\nOu pose-moi une question !",
      "H√© ! üëã\nJe suis le chatbot d'orientation du lyc√©e.\nCon√ßu par des √©l√®ves, pour des √©l√®ves.\n\nTu cherches une formation dans quel domaine ?"
    ],
    replies: [] // Pas de boutons au d√©but
  },

  // √âLECTRICIT√â
  elec_choice: {
    bot: "üîå √âlectricit√© : CAP ou Bac Pro ?",
    replies: [
      { label: "üéì CAP √âlectricien (2 ans)", value: "cap_elec" },
      { label: "üìà Bac Pro MELEC (3 ans)", value: "bac_melec" },
      { label: "üîÑ Alternance", value: "alt_elec" },
      //{ label: "üîô Retour", value: "back" },
    ],
    next: (ans) => {
      if (ans === "cap_elec") return "result_cap_elec";
      if (ans === "bac_melec") return "result_bac_melec";
      if (ans === "alt_elec") return "result_alt_elec";
      return "start";
    },
  },

  // M√âTALLERIE
  metal_choice: {
    bot: "üß± M√©tallerie : CAP ou Bac Pro ?",
    replies: [
      { label: "üéì CAP M√©tallier (2 ans)", value: "cap_metal" },
      { label: "üìà Bac Pro M√©tallerie (3 ans)", value: "bac_metal" },
      { label: "üîÑ Alternance", value: "alt_metal" },
      //{ label: "üîô Retour", value: "back" },
    ],
    next: (ans) => {
      if (ans === "cap_metal") return "result_cap_metallier";
      if (ans === "bac_metal") return "result_bac_metallerie";
      if (ans === "alt_metal") return "result_alt_metallerie";
      return "start";
    },
  },

  // COMMERCE
  commerce_choice: {
    bot: "üõçÔ∏è Commerce : quelle voie ?",
    replies: [
      { label: "üéì CAP √âquipier Polyvalent", value: "cap_commerce" },
      { label: "üß≠ 2nde MRC (d√©couverte)", value: "seconde_mrc" },
      //{ label: "üìà Bac Pro Commerce/Vente", value: "bac_commerce" },
      { label: "üîÑ Alternance", value: "alt_commerce" },
      //{ label: "üîô Retour", value: "back" },
    ],
    next: (ans) => {
      if (ans === "cap_commerce") return "result_cap_epc";
      if (ans === "seconde_mrc") return "result_seconde_mrc";
      if (ans === "bac_commerce") return "result_bac_commerce_vente";
      if (ans === "alt_commerce") return "result_alt_commerce";
      return "start";
    },
  },

  // ALTERNANCE
  alternance_choice: {
    bot: "üîÑ Alternance disponible en :\n‚Ä¢ √âlectricit√©\n‚Ä¢ M√©tallerie\n‚Ä¢ Commerce\n\nTu veux quel secteur ?",
    replies: [
      { label: "‚ö° √âlectricit√©", value: "alt_elec" },
      { label: "üß± M√©tallerie", value: "alt_metal" },
      { label: "üõçÔ∏è Commerce", value: "alt_commerce" },
      //{ label: "üîô Retour", value: "back" },
    ],
    next: (ans) => {
      if (ans === "alt_elec") return "result_alt_elec";
      if (ans === "alt_metal") return "result_alt_metallerie";
      if (ans === "alt_commerce") return "result_alt_commerce";
      return "start";
    },
  },

  // CHOIX CAP
  cap_choice: {
    bot: "üéì CAP disponible en :\n‚Ä¢ √âlectricit√©\n‚Ä¢ M√©tallerie\n‚Ä¢ Commerce\n\nTu pr√©f√®res lequel ?",
    replies: [
      { label: "‚ö° CAP √âlectricien", value: "cap_elec" },
      { label: "üß± CAP M√©tallier", value: "cap_metal" },
      { label: "üõçÔ∏è CAP Commerce", value: "cap_commerce" },
      //{ label: "üîô Retour", value: "back" },
    ],
    next: (ans) => {
      if (ans === "cap_elec") return "result_cap_elec";
      if (ans === "cap_metal") return "result_cap_metallier";
      if (ans === "cap_commerce") return "result_cap_epc";
      return "start";
    },
  },

  // CHOIX BAC PRO
  bac_choice: {
    bot: "üìà Bac Pro disponible en :\n‚Ä¢ √âlectricit√© (MELEC)\n‚Ä¢ M√©tallerie\n‚Ä¢ Commerce/Vente\n‚Ä¢ Gestion (AGOrA)\n‚Ä¢ Accueil\n\nLequel te tente ?",
    replies: [
      { label: "‚ö° MELEC", value: "bac_melec" },
      { label: "üß± M√©tallerie", value: "bac_metal" },
      { label: "üõçÔ∏è Commerce/Vente", value: "bac_commerce" },
      { label: "üìÅ AGOrA", value: "agora" },
      { label: "üôÇ Accueil", value: "accueil" },
      //{ label: "üîô Retour", value: "back" },
    ],
    next: (ans) => {
      if (ans === "bac_melec") return "result_bac_melec";
      if (ans === "bac_metal") return "result_bac_metallerie";
      if (ans === "bac_commerce") return "result_bac_commerce_vente";
      if (ans === "agora") return "result_bac_agora";
      if (ans === "accueil") return "result_bac_accueil";
      return "start";
    },
  },

  // ----- R√âSULTATS (avec cartes) -----
  result_cap_elec: { result: ["cap_elec"] },
  result_bac_melec: { result: ["bac_melec"] },
  result_cap_metallier: { result: ["cap_metallier"] },
  result_bac_metallerie: { result: ["bac_metallerie"] },
  result_cap_epc: { result: ["cap_epc"] },
  result_seconde_mrc: { result: ["seconde_mrc"] },
  result_bac_commerce_vente: { result: ["bac_commerce_vente"] },
  result_bac_agora: { result: ["bac_agora"] },
  result_bac_accueil: { result: ["bac_accueil"] },
  result_alt_commerce: { result: ["alt_commerce"] },
  result_alt_elec: { result: ["alt_elec"] },
  result_alt_metallerie: { result: ["alt_metallerie"] },
};


/* =========================
   5) √âtat + helpers
   ========================= */
let state = { nodeId: "start", history: [] };
let demoTimer = null;

function nowTime() {
  const d = new Date();
  return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
}
function scrollToBottom() {
  mainEl.scrollTop = mainEl.scrollHeight;
}
function setStatus(text) {
  statusChip.textContent = text;
}

/* =========================
   6) Messages (UI)
   ========================= */
function addMessage({ from, text, html }) {
  const row = document.createElement("div");
  row.className = "row " + (from === "bot" ? "bot" : "user");

  if (from === "bot") {
    const av = document.createElement("div");
    av.className = "avatar";
    av.textContent = "ü§ñ";
    row.appendChild(av);
  }

  const bubble = document.createElement("div");
  bubble.className = "bubble";
  if (html) bubble.innerHTML = html;
  else bubble.textContent = text;

  const meta = document.createElement("div");
  meta.className = "meta";
  meta.textContent = nowTime();

  if (from === "user") {
    row.appendChild(meta);
    row.appendChild(bubble);
  } else {
    row.appendChild(bubble);
    row.appendChild(meta);
  }

  messagesEl.appendChild(row);
  scrollToBottom();
}

function addTyping() {
  const row = document.createElement("div");
  row.className = "row bot";
  row.dataset.typing = "1";

  const av = document.createElement("div");
  av.className = "avatar";
  av.textContent = "ü§ñ";

  const bubble = document.createElement("div");
  bubble.className = "bubble";
  bubble.innerHTML = `<span class="typing" aria-label="Le bot √©crit">
      <span class="dot"></span><span class="dot"></span><span class="dot"></span>
    </span>`;

  row.appendChild(av);
  row.appendChild(bubble);
  messagesEl.appendChild(row);
  scrollToBottom();
}
function removeTyping() {
  const t = messagesEl.querySelector('[data-typing="1"]');
  if (t) t.remove();
}

/* =========================
   7) Effet ChatGPT : mot par mot (VERSION CORRIG√âE)
   ========================= */
function escapeHtml(str) {
  return str
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function typewriterMessage(text, { speed = 45, onComplete } = {}) {
  setStatus("√âcrit‚Ä¶");
  quickRepliesEl.style.display = "none";

  const row = document.createElement("div");
  row.className = "row bot";

  const av = document.createElement("div");
  av.className = "avatar";
  av.textContent = "ü§ñ";

  const bubble = document.createElement("div");
  bubble.className = "bubble";
  bubble.innerHTML = "";

  const meta = document.createElement("div");
  meta.className = "meta";
  meta.textContent = nowTime();

  row.appendChild(av);
  row.appendChild(bubble);
  row.appendChild(meta);
  messagesEl.appendChild(row);
  scrollToBottom();

  // Pour le texte simple : effet caract√®re par caract√®re
  let i = 0;
  const timer = setInterval(() => {
    bubble.innerHTML += text.charAt(i);
    i++;
    scrollToBottom();
    
    if (i >= text.length) {
      clearInterval(timer);
      setStatus("Pr√™t");
      quickRepliesEl.style.display = "flex";
      if (onComplete) onComplete();
    }
  }, speed);
}

function typewriterHTML(html, { speed = 18, onComplete } = {}) {
  setStatus("√âcrit‚Ä¶");
  quickRepliesEl.style.display = "none";

  const row = document.createElement("div");
  row.className = "row bot";

  const av = document.createElement("div");
  av.className = "avatar";
  av.textContent = "ü§ñ";

  const bubble = document.createElement("div");
  bubble.className = "bubble";
  bubble.innerHTML = "";

  const meta = document.createElement("div");
  meta.className = "meta";
  meta.textContent = nowTime();

  row.appendChild(av);
  row.appendChild(bubble);
  row.appendChild(meta);
  messagesEl.appendChild(row);
  scrollToBottom();

  // Pour le HTML : on l'injecte directement (pas d'effet caract√®re)
  setTimeout(() => {
    bubble.innerHTML = html;
    scrollToBottom();
    setStatus("Pr√™t");
    quickRepliesEl.style.display = "flex";
    if (onComplete) onComplete();
  }, 300); // Petit d√©lai pour l'effet "r√©flexion"
}

function botSay(textOrHtml, { html = false, speed = 45, onComplete } = {}) {
  quickRepliesEl.style.display = "none";
  addTyping();
  
  const delay = 200 + Math.random() * 150;
  window.setTimeout(() => {
    removeTyping();
    
    if (html) {
      // C'est du HTML ‚Üí on l'affiche directement (pas d'effet caract√®re)
      typewriterHTML(textOrHtml, { speed, onComplete });
    } else {
      // C'est du texte ‚Üí effet caract√®re par caract√®re
      typewriterMessage(textOrHtml, { speed, onComplete });
    }
  }, delay);
}

/* =========================
   8) R√âPONSES AL√âATOIRES
   ========================= */
function getRandomReply(keyword) {
  const keywordData = KEYWORDS[keyword];
  if (keywordData && keywordData.replies) {
    const randomIndex = Math.floor(Math.random() * keywordData.replies.length);
    return keywordData.replies[randomIndex];
  }
  return null;
}

/* =========================
   9) GESTION DU TEXTE LIBRE (CORRIG√â)
   ========================= */
function handleUserInput(inputText) {
  const text = inputText.toLowerCase().trim();
  
  // Ignorer si vide
  if (!text) return null;
  
  // V√©rifier les salutations
  if (text.includes("salut") || text.includes("bonjour") || text.includes("hello") || text === "bjr" || text === "slt") {
    return { type: "greeting", keyword: "salut" };
  }
  
  if (text.includes("merci") || text.includes("thanks") || text.includes("thank")) {
    return { type: "reply", keyword: "merci" };
  }
  
  if (text.includes("au revoir") || text.includes("bye") || text.includes("ciao") || text.includes("a+") || text.includes("√† plus")) {
    return { type: "reply", keyword: "aurevoir" };
  }

  if (text.includes("aide") || text.includes("help") || text.includes("quoi") || text.includes("comment")) {
    return { type: "reply", keyword: "aide" };
  }

  // === GESTION DU CONTEXTE ===
  const currentNode = state.nodeId;
  
  // üí° CAS SP√âCIAL: Si on vient juste de demander un domaine apr√®s un "CAP" ou "Bac Pro" g√©n√©rique
  // Exemple: utilisateur a dit "cap" puis "√©lectricit√©" ‚Üí on va directement au CAP √©lec
  const lastUserMessage = state.history.length > 0 ? state.history[state.history.length - 1] : null;
  const justAskedForDomain = lastUserMessage && 
    (lastUserMessage.answer === "cap" || 
     lastUserMessage.answer === "bacpro" || 
     lastUserMessage.answer?.includes("cap") ||
     lastUserMessage.answer?.includes("bac"));
  
  if (justAskedForDomain) {
    // Si l'utilisateur avait demand√© "cap" juste avant et maintenant donne un domaine
    if (lastUserMessage.answer?.includes("cap") || lastUserMessage.answer === "cap") {
      if (text.includes("elec") || text.includes("√©lectricit√©") || text.includes("electricite")) {
        return { type: "flow", keyword: "cap_elec" };
      }
      if (text.includes("metal") || text.includes("m√©tal") || text.includes("metallerie")) {
        return { type: "flow", keyword: "cap_metal" };
      }
      if (text.includes("commerce") || text.includes("vente")) {
        return { type: "flow", keyword: "cap_commerce" };
      }
    }
    
    // Si l'utilisateur avait demand√© "bac" juste avant et maintenant donne un domaine
    if (lastUserMessage.answer?.includes("bac") || lastUserMessage.answer === "bacpro") {
      if (text.includes("elec") || text.includes("√©lectricit√©") || text.includes("electricite")) {
        return { type: "flow", keyword: "bac_elec" };
      }
      if (text.includes("metal") || text.includes("m√©tal") || text.includes("metallerie")) {
        return { type: "flow", keyword: "bac_metal" };
      }
      if (text.includes("commerce") || text.includes("vente")) {
        return { type: "flow", keyword: "bac_commerce" };
      }
      if (text.includes("gestion") || text.includes("agora")) {
        return { type: "flow", keyword: "gestion" };
      }
      if (text.includes("accueil")) {
        return { type: "flow", keyword: "accueil" };
      }
    }
  }
  
  // Si on est dans le choix √©lectricit√©
  if (currentNode === "elec_choice") {
    if (text.includes("cap")) {
      return { type: "flow", keyword: "cap_elec" };
    }
    if (text.includes("bac") || text.includes("bacpro") || text.includes("bac pro") || text.includes("melec")) {
      return { type: "flow", keyword: "bac_elec" };
    }
    if (text.includes("alternance") || text.includes("alt")) {
      return { type: "flow", keyword: "alternance", context: "elec" };
    }
  }
  
  // Si on est dans le choix m√©tallerie
  if (currentNode === "metal_choice") {
    if (text.includes("cap")) {
      return { type: "flow", keyword: "cap_metal" };
    }
    if (text.includes("bac") || text.includes("bacpro") || text.includes("bac pro")) {
      return { type: "flow", keyword: "bac_metal" };
    }
    if (text.includes("alternance") || text.includes("alt")) {
      return { type: "flow", keyword: "alternance", context: "metal" };
    }
  }
  
  // Si on est dans le choix commerce
  if (currentNode === "commerce_choice") {
    if (text.includes("cap")) {
      return { type: "flow", keyword: "cap_commerce" };
    }
    if (text.includes("2nde") || text.includes("mrc") || text.includes("seconde")) {
      return { type: "flow", keyword: "seconde_mrc" };
    }
    if (text.includes("bac") || text.includes("bacpro") || text.includes("bac pro") || text.includes("vente")) {
      return { type: "flow", keyword: "bac_commerce" };
    }
    if (text.includes("alternance") || text.includes("alt")) {
      return { type: "flow", keyword: "alternance", context: "commerce" };
    }
  }

  // === RECHERCHE DE MOTS-CL√âS PAR PRIORIT√â ===
  
  // 1. Mots-cl√©s sp√©cifiques avec contexte (CAP + domaine)
  if (text.includes("cap") && text.includes("elec")) {
    return { type: "flow", keyword: "cap_elec" };
  }
  if (text.includes("cap") && (text.includes("metal") || text.includes("m√©tal"))) {
    return { type: "flow", keyword: "cap_metal" };
  }
  if (text.includes("cap") && (text.includes("commerce") || text.includes("vente"))) {
    return { type: "flow", keyword: "cap_commerce" };
  }
  
  if ((text.includes("bac") || text.includes("bacpro")) && text.includes("elec")) {
    return { type: "flow", keyword: "bac_elec" };
  }
  if ((text.includes("bac") || text.includes("bacpro")) && (text.includes("metal") || text.includes("m√©tal"))) {
    return { type: "flow", keyword: "bac_metal" };
  }
  if ((text.includes("bac") || text.includes("bacpro")) && (text.includes("commerce") || text.includes("vente"))) {
    return { type: "flow", keyword: "bac_commerce" };
  }
  if ((text.includes("bac") || text.includes("bacpro")) && (text.includes("gestion") || text.includes("agora"))) {
    return { type: "flow", keyword: "gestion" };
  }
  if ((text.includes("bac") || text.includes("bacpro")) && text.includes("accueil")) {
    return { type: "flow", keyword: "accueil" };
  }

  // 2. Domaines principaux
  if (text.includes("electricite") || text.includes("elec") || text.includes("√©lectricit√©") || text.includes("√©lectricien")) {
    return { type: "flow", keyword: "electricite" };
  }
  
  if (text.includes("metallerie") || text.includes("metal") || text.includes("m√©tallerie") || text.includes("serrurier") || text.includes("m√©tal")) {
    return { type: "flow", keyword: "metallerie" };
  }
  
  if (text.includes("commerce") || text.includes("vente") || text.includes("magasin") || text.includes("rayon") || text.includes("vendeur")) {
    return { type: "flow", keyword: "commerce" };
  }
  
  if (text.includes("gestion") || text.includes("agora") || text.includes("gatll") || text.includes("administration") || text.includes("assistant")) {
    return { type: "flow", keyword: "gestion" };
  }
  
  if (text.includes("accueil") || text.includes("acceuil") || text.includes("hotesse") || text.includes("h√¥tesse")) {
    return { type: "flow", keyword: "accueil" };
  }
  
  if (text.includes("alternance") || text.includes("alterner") || text.includes("apprentissage") || text.includes("contrat")) {
    return { type: "flow", keyword: "alternance" };
  }
  
  // 3. CAP et Bac Pro sans contexte ‚Üí demander le domaine
  if (text.includes("cap") && !text.includes("bac")) {
    // On garde en m√©moire que l'utilisateur a demand√© un CAP
    return { 
      type: "unknown", 
      keyword: "cap",
      text: "üéì CAP dans quel domaine ? On propose :\n‚Ä¢ √âlectricit√©\n‚Ä¢ M√©tallerie\n‚Ä¢ Commerce" 
    };
  }
  
  if ((text.includes("bac") || text.includes("bacpro")) && !text.includes("cap")) {
    return { 
      type: "unknown", 
      keyword: "bacpro",
      text: "üìà Bac Pro dans quel domaine ? On propose :\n‚Ä¢ √âlectricit√© (MELEC)\n‚Ä¢ M√©tallerie\n‚Ä¢ Commerce/Vente\n‚Ä¢ Gestion (AGOrA)\n‚Ä¢ Accueil" 
    };
  }
  
  // Aucun mot-cl√© trouv√©
  return { 
    type: "unknown", 
    text: "ü§î Je n'ai pas bien compris. Tu peux √©crire :\n‚Ä¢ √âlectricit√©\n‚Ä¢ M√©tallerie\n‚Ä¢ Commerce\n‚Ä¢ Gestion (AGOrA)\n‚Ä¢ Accueil\n‚Ä¢ Alternance\n\nOu directement : CAP √©lectricien, Bac Pro commerce..." 
  };
}
/* =========================
   10) Quick replies (boutons)
   ========================= */
function setReplies(replies) {
  quickRepliesEl.innerHTML = "";

  (replies || []).forEach((r, idx) => {
    const b = document.createElement("button");
    b.className = "qr " + (idx === 0 ? "accent" : idx === 1 ? "good" : "");
    b.textContent = r.label;
    b.onclick = () => onUserAnswer(r);
    quickRepliesEl.appendChild(b);
  });

  // Bouton "C'est quoi l'alternance ?" SEULEMENT apr√®s un r√©sultat d'alternance
  const nodeId = state.nodeId;
  if (nodeId.startsWith('result_alt_')) {
    const alt = document.createElement("button");
    alt.className = "qr";
    alt.textContent = "‚ÑπÔ∏è C'est quoi l'alternance ?";
    alt.onclick = () => showAlternanceInfo();
    quickRepliesEl.appendChild(alt);
  }

  // Bouton restart
  const restart = document.createElement("button");
  restart.className = "qr warn";
  restart.textContent = "‚Ü∫ Recommencer";
  restart.onclick = restartFlow;
  quickRepliesEl.appendChild(restart);
}

/* =========================
   11) Cartes r√©sultats (version HTML)
   ========================= */
function renderResultCards(keys) {
  const cards = keys
    .map((k) => {
      const p = PROGRAMS[k];
      const jobs = (p.jobs || []).map((j) => `‚Ä¢ ${escapeHtml(j)}`).join("<br>");
      return `
      <div class="card">
        <div class="badge">${escapeHtml(p.badge)}</div>
        <h3>${escapeHtml(p.title)}</h3>
        <p>${escapeHtml(p.pitch)}</p>
        <p><strong>Exemples de m√©tiers :</strong><br>${jobs}</p>
        <p><strong>Et apr√®s :</strong> ${escapeHtml(p.next)}</p>
        <div class="actions">
          <a class="link" href="${p.pageUrl}" target="_blank" rel="noopener">üìÑ Page formation</a>
        </div>
      </div>
    `;
    })
    .join("");

  return `
    <div>
      <div style="margin-bottom:10px; font-weight:800;">Voici ce que je te propose üëá</div>
      <div class="cards">${cards}</div>
      <div style="margin-top:10px; color: rgba(255,255,255,.70); font-size:13px;">
        Tu peux recommencer pour tester un autre profil.
      </div>
    </div>
  `;
}


/* =========================
   12) Navigation
   ========================= */
function goTo(nodeId) {
  state.nodeId = nodeId;
  const node = FLOW[nodeId];

  // R√©sultat ? -> Affiche les cartes de formation en HTML
  if (node.result) {
    botSay("Je r√©fl√©chis √† la meilleure formation pour toi‚Ä¶", {
      speed: 30,
      onComplete: () => {
        const html = renderResultCards(node.result);
        botSay(html, { 
          html: true,  // ‚Üê IMPORTANT : c'est du HTML !
          speed: 18,
          onComplete: () => {
            setReplies([
              { label: "üîÅ Refaire le test", value: "__restart__" },
              { label: "üß≠ Voir toutes les formations", value: "__all__" },
            ]);
          }
        });
      }
    });
    return;
  }

  // Question normale (texte)
  const botMessage = Array.isArray(node.bot) ? getRandomArrayItem(node.bot) : node.bot;
  
  if (node.replies && node.replies.length > 0) {
    botSay(botMessage, {
      speed: 35,
      onComplete: () => {
        setReplies(node.replies);
      }
    });
  } else {
    botSay(botMessage, {
      speed: 35,
      onComplete: () => {}
    });
  }
}

/* =========================
   13) Gestion des r√©ponses utilisateur (CORRIG√â)
   ========================= */
function onUserAnswer(reply) {
  quickRepliesEl.style.display = "none";
  
  // Actions sp√©ciales boutons
  if (reply.value === "__restart__") {
    restartFlow();
    return;
  }
  if (reply.value === "__all__") {
    showAllPrograms();
    return;
  }
  if (reply.value === "back") {
    addMessage({ from: "user", text: "üîô Retour" });
    goTo("start");
    return;
  }

  // Si c'est un bouton normal
  if (reply.value && !reply.isText) {
    addMessage({ from: "user", text: reply.label });
    
    const current = FLOW[state.nodeId];
    state.history.push({ nodeId: state.nodeId, answer: reply.value });
    
    const nextId = typeof current.next === "function" ? current.next(reply.value) : current.next;
    goTo(nextId);
    return;
  }
  
  // Si c'est du texte libre
  if (reply.isText) {
    addMessage({ from: "user", text: reply.label });
    
    const result = handleUserInput(reply.label);
    
    if (result.type === "greeting") {
      const replyText = getRandomReply("salut");
      botSay(replyText, { speed: 50, onComplete: () => goTo("start") });
    }
    else if (result.type === "reply") {
      const replyText = getRandomReply(result.keyword);
      botSay(replyText, { speed: 50, onComplete: () => {} });
    }
    else if (result.type === "flow") {
      const replyText = getRandomReply(result.keyword);
      
      // D√©terminer la prochaine √©tape
      let nextNode = "start";
      if (result.keyword === "electricite") nextNode = "elec_choice";
      if (result.keyword === "metallerie") nextNode = "metal_choice";
      if (result.keyword === "commerce") nextNode = "commerce_choice";
      if (result.keyword === "gestion") nextNode = "result_bac_agora";
      if (result.keyword === "accueil") nextNode = "result_bac_accueil";
      if (result.keyword === "alternance") nextNode = "alternance_choice";
      if (result.keyword === "cap_elec") nextNode = "result_cap_elec";
      if (result.keyword === "cap_metal") nextNode = "result_cap_metallier";
      if (result.keyword === "cap_commerce") nextNode = "result_cap_epc";
      if (result.keyword === "bac_elec") nextNode = "result_bac_melec";
      if (result.keyword === "bac_metal") nextNode = "result_bac_metallerie";
      if (result.keyword === "bac_commerce") nextNode = "result_bac_commerce_vente";
      if (result.keyword === "seconde_mrc") nextNode = "result_seconde_mrc";
      
      botSay(replyText, { speed: 50, onComplete: () => goTo(nextNode) });
    }
    else {
      // üî• CORRECTION ICI : Sauvegarder le contexte CAP/Bac Pro
      if (result.keyword === "cap" || result.keyword === "bacpro") {
        // Sauvegarde dans l'historique pour le prochain message
        state.history.push({ 
          nodeId: state.nodeId, 
          answer: result.keyword 
        });
      }
      
      botSay(result.text, { 
        speed: 50, 
        onComplete: () => {
          // Pas de navigation, on reste sur le m√™me node
        } 
      });
    }
  }
}

/* =========================
   14) Actions sp√©ciales (avec effet d'√©criture)
   ========================= */
function showAlternanceInfo() {
  quickRepliesEl.style.display = "none";
  addMessage({ from: "user", text: "‚ÑπÔ∏è C'est quoi l'alternance ?" });
  botSay(ALTERNANCE_EXPLAIN, {
    speed: 30,
    onComplete: () => {
      const node = FLOW[state.nodeId];
      if (node && node.result) {
        setReplies([
          { label: "üîÅ Refaire le test", value: "__restart__" },
          { label: "üß≠ Voir toutes les formations", value: "__all__" },
        ]);
      }
    }
  });
}

function showAllPrograms() {
  quickRepliesEl.style.display = "none";
  addMessage({ from: "user", text: "üß≠ Voir toutes les formations" });

  botSay("Voici toutes les formations propos√©es au lyc√©e Aim√© C√©saire.", {
    speed: 30,
    onComplete: () => {
      const keys = Object.keys(PROGRAMS);
      let text = "Toutes les formations üëá\n\n";
      
      keys.forEach((k) => {
        const p = PROGRAMS[k];
        text += `[${p.badge}] ${p.title}\n${p.pitch}\n\n`;
      });
      
      text += "\nTu peux revenir au test quand tu veux.";
      
      botSay(text, { 
        speed: 25,
        onComplete: () => {
          setReplies([{ label: "üîÅ Refaire le test", value: "__restart__" }]);
        }
      });
    }
  });
}
/* =========================
   15) Restart + Intro
   ========================= */
function restartFlow() {
  stopDemo();
  messagesEl.innerHTML = "";
  quickRepliesEl.style.display = "none";
  state = { nodeId: "start", history: [] };
  setStatus("Pr√™t");
  
  // Message d'intro al√©atoire - avec effet d'√©criture
  const startMessages = FLOW["start"].bot;
  const randomMessage = Array.isArray(startMessages) 
    ? startMessages[Math.floor(Math.random() * startMessages.length)]
    : startMessages;
  
  botSay(randomMessage, {
    speed: 40,
    onComplete: () => {
      // PAS de boutons au d√©marrage
      quickRepliesEl.innerHTML = "";
    }
  });
}

function intro() {
  quickRepliesEl.style.display = "none";
  // Attendre un peu puis d√©marrer
  setTimeout(() => {
    restartFlow();
  }, 300);
}



// Helper pour choisir un message al√©atoire
function getRandomArrayItem(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

/* =========================
   16) INPUT TEXTE LIBRE
   ========================= */
function addTextInput() {
  // V√©rifier si l'input existe d√©j√†
  if (document.querySelector('.text-input-container')) return;
  
  const container = document.createElement("div");
  container.className = "text-input-container";
  container.style.cssText = `
    display: flex;
    padding: 12px 16px;
    background: #1a1e24;
    border-top: 1px solid #333;
    position: sticky;
    bottom: 0;
    width: 100%;
    box-sizing: border-box;
    z-index: 100;
  `;
  
  const input = document.createElement("input");
  input.type = "text";
  input.placeholder = "√âcris ta question ici... (√©lectricit√©, commerce, CAP...)";
  input.style.cssText = `
    flex: 1;
    padding: 12px 16px;
    border-radius: 24px;
    border: 1px solid #444;
    background: #2a2f38;
    color: white;
    font-size: 15px;
    outline: none;
    transition: all 0.2s;
  `;
  
  input.onfocus = () => {
    input.style.borderColor = "#4f9eff";
    input.style.background = "#2f3540";
  };
  
  input.onblur = () => {
    input.style.borderColor = "#444";
    input.style.background = "#2a2f38";
  };
  
  const sendBtn = document.createElement("button");
  sendBtn.innerHTML = `‚û§`;
  sendBtn.style.cssText = `
    margin-left: 10px;
    padding: 12px 20px;
    border-radius: 24px;
    border: none;
    background: #4f9eff;
    color: white;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.2s;
  `;
  
  sendBtn.onmouseover = () => {
    sendBtn.style.background = "#3a8eef";
  };
  
  sendBtn.onmouseout = () => {
    sendBtn.style.background = "#4f9eff";
  };
  
  sendBtn.onclick = () => {
    if (input.value.trim()) {
      onUserAnswer({ label: input.value, value: null, isText: true });
      input.value = "";
    }
  };
  
  input.onkeypress = (e) => {
    if (e.key === "Enter" && input.value.trim()) {
      onUserAnswer({ label: input.value, value: null, isText: true });
      input.value = "";
    }
  };
  
  container.appendChild(input);
  container.appendChild(sendBtn);
  
  // Ins√©rer apr√®s quickReplies
  const parent = quickRepliesEl.parentNode;
  parent.insertBefore(container, quickRepliesEl.nextSibling);
}

/* =========================
   17) Mode D√©mo
   ========================= */
function startDemo() {
  stopDemo();
  btnDemo.textContent = "‚è∏ Stop d√©mo";
  btnDemo.dataset.on = "1";
  restartFlow();

  const script = [
    { wait: 1500, pickIndex: 0 }, // tech
    { wait: 1500, pickIndex: 0 }, // CAP √©lec
  ];

  let i = 0;

  function step() {
    if (!btnDemo.dataset.on) return;

    const node = FLOW[state.nodeId];
    if (!node || !node.replies) return;

    const idx = script[i]?.pickIndex ?? 0;
    const r = node.replies[Math.min(idx, node.replies.length - 1)];
    if (!r) return;

    onUserAnswer(r);
    i++;

    if (i < script.length) {
      demoTimer = setTimeout(step, script[i].wait);
    }
  }

  demoTimer = setTimeout(step, script[0].wait);
}

function stopDemo() {
  if (demoTimer) clearTimeout(demoTimer);
  demoTimer = null;
  btnDemo.textContent = "‚ñ∂ D√©mo";
  btnDemo.removeAttribute("data-on");
}

/* =========================
   18) Event Listeners
   ========================= */
btnRestart?.addEventListener("click", restartFlow);
btnDemo?.addEventListener("click", () => {
  if (btnDemo.dataset.on) stopDemo();
  else startDemo();
});

/* =========================
   19) Lancement
   ========================= */
// Attendre que le DOM soit charg√©
if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", () => {
    intro();
    setTimeout(addTextInput, 200);
  });
} else {
  intro();
  setTimeout(addTextInput, 200);
}
</script>
</body>
</html>


<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chatbot Orientation â€” LycÃ©e AimÃ© CÃ©saire</title>

  <style>
  :root{
    --bg:#0b1020;
    --panel:rgba(255,255,255,.06);
    --panel2:rgba(255,255,255,.08);
    --text:rgba(255,255,255,.92);
    --muted:rgba(255,255,255,.65);
    --accent:#7c3aed;
    --accent2:#22c55e;
    --danger:#ef4444;
    --shadow:0 18px 60px rgba(0,0,0,.45);
    --radius:18px;
  }

  *{box-sizing:border-box}
  html,body{height:100%}

  body{
    margin:0;
    color:var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    background:
      radial-gradient(1200px 800px at 20% 10%, rgba(124,58,237,.35), transparent 60%),
      radial-gradient(900px 600px at 90% 30%, rgba(34,197,94,.25), transparent 55%),
      radial-gradient(800px 700px at 40% 90%, rgba(59,130,246,.20), transparent 55%),
      linear-gradient(180deg, #070a14, #0b1020 60%, #070a14);
    display:block; /* important mobile */
    padding:0;
  }

  /* App full screen (mobile like ChatGPT) */
  .app{
    width:100%;
    height:100dvh;
    overflow:hidden;
    display:grid;
    grid-template-rows: 64px 1fr auto;
    border:0;
    border-radius:0;
    box-shadow:none;
    background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
  }

  /* Header sticky */
  header{
    position:sticky;
    top:0;
    z-index:200;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:14px 16px;
    border-bottom:1px solid rgba(255,255,255,.10);
    backdrop-filter: blur(10px);
    background: rgba(10,14,28,.55);
  }

  .brand{display:flex; gap:12px; align-items:center; min-width:0;}
  .logo{
    width:40px; height:40px; border-radius:14px;
    background:
      radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.45), transparent 60%),
      linear-gradient(135deg, rgba(124,58,237,.95), rgba(34,197,94,.8));
    box-shadow: 0 10px 30px rgba(124,58,237,.22);
    flex:0 0 auto;
  }

  .title{display:flex; flex-direction:column; line-height:1.1; min-width:0;}
  .title strong{
    font-size:14px;
    letter-spacing:.2px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .title span{
    font-size:12px;
    color:var(--muted);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .header-actions{display:flex; gap:10px; align-items:center;}
  .chip{
    font-size:12px;
    padding:8px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.05);
    color: var(--muted);
  }

  /* Main scroll area */
  main{
    padding:16px;
    overflow-y:auto;
    overflow-x:hidden;
    scroll-behavior:smooth;
    height:100%;
    /* espace pour quick replies + input sticky */
    padding-bottom: 140px;
  }

  /* Messages container */
  .messages{
    display:flex;
    flex-direction:column;
    gap:12px;
    width:100%;
    margin:0;
    max-width:none;
  }

  .row{
    display:flex;
    gap:10px;
    align-items:flex-end;
    width:100%;
    animation: fadeIn .25s ease;
  }
  @keyframes fadeIn{
    from{opacity:0; transform:translateY(10px)}
    to{opacity:1; transform:translateY(0)}
  }
  .row.bot{justify-content:flex-start;}
  .row.user{justify-content:flex-end;}

  /* Avatar hidden on mobile (optionnel) */
  .avatar{
    width:34px;height:34px;border-radius:12px;
    background: rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.12);
    display:none;
    align-items:center; justify-content:center;
    font-size:16px;
    flex:0 0 auto;
  }

  /* Bubble: full width on mobile */
  .bubble{
    width:100%;
    max-width:100%;
    padding:12px 14px;
    border-radius: var(--radius);
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06);
    box-shadow: 0 10px 26px rgba(0,0,0,.16);
    line-height:1.45;
    font-size:14px;
    white-space:pre-wrap;
    word-break: break-word;
  }
  .row.user .bubble{
    background: linear-gradient(135deg, rgba(124,58,237,.30), rgba(124,58,237,.16));
    border-color: rgba(124,58,237,.45);
  }

  .meta{
    font-size:11px;
    color: rgba(255,255,255,.55);
    margin: 0 6px;
    white-space: nowrap;
    display:none;
  }

  /* Cards */
  .cards{
    display:grid;
    grid-template-columns:1fr;
    gap:12px;
    margin-top:10px;
  }
  @media (min-width:640px){
    .cards{ grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
  }

  .card{
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.05);
    border-radius:18px;
    padding:16px;
    display:flex;
    flex-direction:column;
    gap:10px;
    transition: transform .2s ease, border-color .2s ease;
  }
  .card:hover{
    border-color: rgba(124,58,237,.4);
    transform: translateY(-2px);
  }
  .card h3{margin:0; font-size:15px; letter-spacing:.2px; font-weight:700;}
  .badge{
    display:inline-flex;
    align-items:center;
    gap:6px;
    font-size:11px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    width: fit-content;
    color: var(--muted);
  }
  .card p{margin:0; color:var(--muted); font-size:13px; line-height:1.45;}
  .card .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:4px;}

  .link{
    text-decoration:none;
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    color: var(--text);
    font-weight:600;
    font-size:12px;
    transition: all .2s ease;
  }
  .link:hover{
    background: rgba(255,255,255,.12);
    border-color: rgba(255,255,255,.25);
  }

  /* Quick replies + composer host (bottom area) */
  #composerHost{
    position: sticky;
    bottom: 0;
    z-index: 250;
    background: rgba(10,14,28,.75);
    backdrop-filter: blur(10px);
    border-top: 1px solid rgba(255,255,255,.10);
  }

  .quick-replies{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:center;
    padding:10px 14px 0 14px;
    max-width: 980px;
    margin:0 auto;
  }

  .qr{
    cursor:pointer;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    color: var(--text);
    padding:10px 14px;
    border-radius:999px;
    font-weight:600;
    font-size:13px;
    transition: all .15s ease;
    user-select:none;
  }
  .qr:hover{
    background: rgba(255,255,255,.12);
    border-color: rgba(255,255,255,.25);
    transform: translateY(-1px);
  }
  .qr:active{ transform: translateY(1px); }
  .qr.accent{ border-color: rgba(124,58,237,.55); background: rgba(124,58,237,.2); }
  .qr.good{ border-color: rgba(34,197,94,.55); background: rgba(34,197,94,.14); }
  .qr.warn{ border-color: rgba(239,68,68,.55); background: rgba(239,68,68,.12); }

  /* Composer (text input) */
  .text-input-container{
    display:flex;
    gap:10px;
    padding:10px 14px 14px 14px;
    width:100%;
    max-width: 980px;
    margin:0 auto;
    box-sizing:border-box;
  }

  .text-input-container input{
    flex:1;
    padding:12px 18px;
    border-radius:30px;
    border:1px solid rgba(255,255,255,.15);
    background: rgba(255,255,255,.07);
    color:white;
    font-size:14px;
    outline:none;
    transition: all .2s ease;
  }
  .text-input-container input:focus{
    border-color: var(--accent);
    background: rgba(255,255,255,.10);
    box-shadow: 0 0 0 3px rgba(124,58,237,.2);
  }
  .text-input-container input::placeholder{
    color: rgba(255,255,255,.5);
  }

  .text-input-container button{
    padding:12px 18px;
    border-radius:30px;
    border:none;
    background: linear-gradient(135deg, var(--accent), #9f67ff);
    color:white;
    font-weight:600;
    font-size:14px;
    cursor:pointer;
    transition: all .2s ease;
    white-space:nowrap;
    box-shadow: 0 4px 12px rgba(124,58,237,.3);
  }
  .text-input-container button:hover{
    transform: translateY(-1px);
    box-shadow: 0 8px 16px rgba(124,58,237,.4);
  }
  .text-input-container button:active{
    transform: translateY(1px);
  }

  /* Typing indicator */
  .typing{display:inline-flex; gap:6px; align-items:center;}
  .dot{
    width:7px;height:7px;border-radius:50%;
    background: rgba(255,255,255,.65);
    animation: bounce 1s infinite ease-in-out;
  }
  .dot:nth-child(2){ animation-delay:.15s; }
  .dot:nth-child(3){ animation-delay:.30s; }
  @keyframes bounce{
    0%,80%,100%{ transform: translateY(0); opacity:.6;}
    40%{ transform: translateY(-6px); opacity:1;}
  }

  /* Links in header title */
  a{
    text-decoration:none;
    color:white;
  }

  /* Scrollbar */
  ::-webkit-scrollbar{ width:6px; }
  ::-webkit-scrollbar-track{ background: rgba(255,255,255,.03); }
  ::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.15); border-radius:10px; }
  ::-webkit-scrollbar-thumb:hover{ background: rgba(255,255,255,.25); }

  /* Desktop refinements */
  @media (min-width: 768px){
    .messages{
      max-width: 820px;
      margin: 0 auto;
    }
    .bubble{
      width:auto;
      max-width: 75%;
    }
    .row.user .bubble{
  width: fit-content;
  max-width: 80%;
  margin-left: auto;      /* pousse Ã  droite */
}
  }

  /* Small screens tweaks */
  @media (max-width: 600px){
    .chip{ display:none; }
    main{ padding:14px; padding-bottom:150px; }
    .text-input-container button{ padding:12px 16px; }
.row.user .bubble{
  width: fit-content;
  max-width: 80%;
  margin-left: auto;      /* pousse Ã  droite */
}
  }
</style>
</head>
<body>
<div class="app" role="application" aria-label="Chatbot orientation">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div class="title">
        <strong><a href="./index.html">CÃ©saireGPT</a></strong>
        <span>DÃ©couvrir les mÃ©tiers et formations en 2 minutes</span>
      </div>
    </div>

    <div class="header-actions">
      <span class="chip" id="statusChip">PrÃªt</span>
      <span  id="btnDemo" type="button" title="Mode dÃ©mo (auto)"></span>
    </div>
  </header>

  <!-- âœ… Zone scroll UNIQUEMENT pour les messages -->
  <main id="main">
    <div class="messages" id="messages"></div>
  </main>

  <!-- âœ… Zone fixe en bas : quick replies + input -->
  <div id="composerHost">
    <div id="quickReplies" class="quick-replies"></div>
    <!-- addTextInput() viendra ajouter .text-input-container ici -->
  </div>
</div>
<script>
    /* =========================
   0) SÃ©lecteurs DOM attendus
   =========================
   Le HTML doit contenir :
   - #messages
   - #quickReplies
   - #main
   - #statusChip
   - #btnRestart
   - #btnDemo
*/
const messagesEl = document.getElementById("messages");
const quickRepliesEl = document.getElementById("quickReplies");
const mainEl = document.getElementById("main");
const statusChip = document.getElementById("statusChip");
const btnRestart = document.getElementById("btnRestart");
const btnDemo = document.getElementById("btnDemo");

/* =========================
   1) CONTENU : formations
   ========================= */
const PROGRAMS = {
  // ===== Initiale =====
cap_elec: {
  title: "CAP Ã‰lectricien / Ã‰lectricienne",
  pitch: "Installer, entretenir et dÃ©panner des systÃ¨mes Ã©lectriques pour assurer lâ€™Ã©nergie et la sÃ©curitÃ© des bÃ¢timents.",
  duration: "2 ans",
  learn: [
    "Lire et interprÃ©ter des plans Ã©lectriques",
    "Installer des circuits et appareils Ã©lectriques",
    "Assurer la sÃ©curitÃ© des installations",
    "Diagnostiquer et rÃ©parer des pannes simples"
  ],
  jobs: [
    "Ã‰lectricien(ne) du bÃ¢timent",
    "Technicien(ne) Ã©lectricien(ne)",
    "Monteur(se) en installations Ã©lectriques"
  ],
  next: "AprÃ¨s le CAP : poursuivre vers une Mention ComplÃ©mentaire ou un Bac Pro en Ã©lectricitÃ© pour aller plus loin.",
  pageUrl: "https://lp-aime-cesaire-lille.59.ac-lille.fr/cap-electricien/",
  mode: "initiale",
  family: "Ã©lectricitÃ©",
},
bac_melec: {
  title: "Bac Pro MÃ©tiers de l'Ã‰lectricitÃ© et de ses Environnements ConnectÃ©s (MELEC)",
  pitch: "Concevoir, installer et maintenir des systÃ¨mes Ã©lectriques performants pour les bÃ¢timents et les environnements connectÃ©s.",
  duration: "3 ans aprÃ¨s la 3áµ‰ (ou 2 ans aprÃ¨s certains CAP)",
  learn: [
    "Analyser et dÃ©finir des installations Ã©lectriques",
    "Installer et raccorder des circuits et Ã©quipements",
    "ParamÃ©trer et contrÃ´ler le bon fonctionnement",
    "Assurer la maintenance et la sÃ©curitÃ© Ã©nergÃ©tique",
    "Travailler avec des technologies connectÃ©es"
  ],
  jobs: [
    "Ã‰lectricien(ne) qualifiÃ©(e)",
    "Technicien(ne) Ã©lectrotechnicien(ne)",
    "Installateur(trice) domotique"
  ],
  next: "AprÃ¨s le Bac Pro : BTS ou spÃ©cialisations techniques pour aller encore plus loin.",
  pageUrl: "https://lp-aime-cesaire-lille.59.ac-lille.fr/bac-pro-metier-de-lelectricite-et-de-ses-environnements-connectes/",
  mode: "initiale",
  family: "Ã©lectricitÃ©",
},
cap_metallier: {
  title: "CAP Serrurier / MÃ©tallier",
  pitch: "Concevoir, fabriquer et poser des Ã©lÃ©ments mÃ©talliques pour les bÃ¢timents et amÃ©nagements.",
  duration: "2 ans",
  learn: [
    "Lire des plans et tracer les piÃ¨ces",
    "DÃ©couper et faÃ§onner des mÃ©taux",
    "Assembler et souder des Ã©lÃ©ments mÃ©talliques",
    "Installer des ouvrages sur chantier",
    "VÃ©rifier la qualitÃ© et la sÃ©curitÃ© des rÃ©alisations"
  ],
  jobs: [
    "MÃ©tallier(Ã¨re)",
    "Serrurier(Ã¨re) mÃ©tallier",
    "Monteur(se) en ouvrages mÃ©talliques"
  ],
  next: "AprÃ¨s le CAP : poursuite possible vers un Bac Pro Ouvrages du BÃ¢timent â€“ MÃ©tallerie ou des mentions complÃ©mentaires pour aller plus loin.",
  pageUrl: "https://lp-aime-cesaire-lille.59.ac-lille.fr/cap-serrurier-metallier/",
  mode: "initiale",
  family: "bÃ¢timent",
},
bac_metallerie: {
  title: "Bac Pro Ouvrages du BÃ¢timent : MÃ©tallerie",
  pitch: "Fabriquer, assembler et poser des structures mÃ©talliques pour le bÃ¢timent (portes, garde-corps, escaliersâ€¦) en atelier et sur chantier.",
  duration: "3 ans aprÃ¨s la 3e",
  learn: [
    "Lire et prÃ©parer des plans techniques",
    "DÃ©couper, faÃ§onner et assembler des piÃ¨ces mÃ©talliques",
    "Installer des ouvrages sur chantier",
    "Travailler avec des outils et machines professionnelles",
    "Respecter les normes de sÃ©curitÃ© et qualitÃ©"
  ],
  jobs: [
    "MÃ©tallier(Ã¨re)",
    "Serrurier(Ã¨re) mÃ©tallier(Ã¨re)",
    "Charpentier(Ã¨re) mÃ©tallique"
  ],
  next: "AprÃ¨s le Bac Pro : BTS ou spÃ©cialisations techniques pour aller plus loin.",
  pageUrl: "https://lp-aime-cesaire-lille.59.ac-lille.fr/bac-pro-ouvrages-du-batiment-metallerie/",
  mode: "initiale",
  family: "bÃ¢timent",
},
cap_epc: {
  title: "CAP Ã‰quipier / Ã‰quipiÃ¨re Polyvalent(e) du Commerce",
  pitch: "Accueillir les clients, participer aux ventes et mettre en valeur les produits en magasin.",
  duration: "2 ans",
  learn: [
    "Mettre en valeur les produits",
    "Organiser un rayon",
    "Accueillir et conseiller les clients",
    "Encaisser et gÃ©rer les stocks"
  ],
  jobs: [
    "EmployÃ©(e) de commerce",
    "Ã‰quipier(Ã¨re) polyvalent(e)",
    "Vendeur(se) en magasin"
  ],
  next: "AprÃ¨s le CAP : poursuite possible en Bac Pro MÃ©tiers du Commerce et de la Vente.",
  pageUrl: "https://lp-aime-cesaire-lille.59.ac-lille.fr/cap-equipier-polyvalent-du-commerce/",
  mode: "initiale",
  family: "commerce",
},
seconde_mrc: {
  title: "2nde Professionnelle MÃ©tiers de la Relation ClientÃ¨le (MRC)",
  pitch: "DÃ©couvrir et apprendre les compÃ©tences clÃ©s du contact client, de la communication et du conseil en vente.",
  duration: "1 an aprÃ¨s la 3e",
  learn: [
    "Accueillir des clients en face-Ã -face et par tÃ©lÃ©phone",
    "Communiquer et comprendre les besoins des clients",
    "Analyser des informations pour mieux conseiller",
    "Conseiller et fidÃ©liser une clientÃ¨le",
    "Suivre la relation client et le service aprÃ¨s-vente"
  ],
  jobs: [
    "Conseiller(Ã¨re) clientÃ¨le",
    "Assistant(e) commercial(e)",
    "Vendeur(se) polyvalent(e)"
  ],
  next: "AprÃ¨s cette 2nde : entrÃ©e en 1re pro MÃ©tiers de lâ€™Accueil, ou MÃ©tiers du Commerce et de la Vente.",
  pageUrl: "https://lp-aime-cesaire-lille.59.ac-lille.fr/2nde-bac-pro-metiers-de-ma-relation-clientele-mrc/",
  mode: "initiale",
  family: "commerce",
},
  bac_commerce_vente: {
    title: "Bac Pro MÃ©tiers du Commerce et de la Vente",
    badge: "ðŸ’¬ Initiale â€” Vente & Conseil",
    pitch: "Conseiller, vendre, fidÃ©liser, organiser un espace de vente et suivre des objectifs.",
    jobs: ["Vendeur(se) conseil", "Conseiller(Ã¨re) clientÃ¨le"],
    next: "AprÃ¨s : BTS MCO / NDRC (selon projet).",
    pageUrl: "https://example.com/page-bac-commerce-vente",
    mode: "initiale",
    family: "commerce",
  },
bac_agora: {
  title: "2nde GATL â†’ Bac Pro AGOrA",
  pitch: "En 2nde, tu dÃ©couvres la Gestion, lâ€™Administration, le Transport et la Logistique (GATL). Ensuite, tu te spÃ©cialises en AGOrA (Assistance Ã  la Gestion des Organisations et de leurs ActivitÃ©s).",
  duration: "3 ans aprÃ¨s la 3e",
  learn: [
    "En 2nde GATL : comprendre le fonctionnement dâ€™une entreprise",
    "Organiser des dossiers administratifs",
    "DÃ©couvrir le transport et la logistique",
    "Utiliser des outils numÃ©riques professionnels",
    "En 1re et Terminale AGOrA : gÃ©rer des activitÃ©s administratives et accompagner une organisation au quotidien"
  ],
  jobs: [
    "Assistant(e) administratif(ve)",
    "Agent de gestion",
    "EmployÃ©(e) en transport ou logistique"
  ],
  next: "AprÃ¨s la 2nde GATL, poursuite en : AGOrA (au lycÃ©e A. CÃ©saire), Organisation de Transport de Marchandises ou Logistique (LP Antoine de Saint-ExupÃ©ry Ã  Halluin).",
  pageUrl: "https://lp-aime-cesaire-lille.59.ac-lille.fr/bac-pro-gestion-administration-transport-logistique/",
  mode: "initiale",
  family: "gestion-administration",
},
bac_accueil: {
  title: "Bac Pro MÃ©tiers de lâ€™Accueil (MAC)",
  pitch: "Apprendre Ã  accueillir, informer et accompagner les personnes dans diffÃ©rents lieux (entreprises, services publics, Ã©vÃ©nementsâ€¦).",
  duration: "3 ans aprÃ¨s la 3e (entrÃ©e possible en 1re aprÃ¨s une 2nde MRC ou GATL)",
  learn: [
    "Accueillir les visiteurs en face-Ã -face, par tÃ©lÃ©phone ou en ligne",
    "Informer et orienter avec clartÃ©",
    "GÃ©rer des rendez-vous et des informations",
    "Utiliser des outils numÃ©riques dâ€™accueil",
    "Assurer un service professionnel et convivial"
  ],
  jobs: [
    "HÃ´te / HÃ´tesse dâ€™accueil",
    "Agent(e) dâ€™accueil et dâ€™information",
    "RÃ©ceptionniste en entreprise ou en Ã©vÃ©nementiel"
  ],
  next: "AprÃ¨s le Bac Pro : BTS ou spÃ©cialisation dans la communication, lâ€™Ã©vÃ©nementiel ou le service client.",
  pageUrl: "https://lp-aime-cesaire-lille.59.ac-lille.fr/bac-pro-metiers-de-laccueil/",
  mode: "initiale",
  family: "service-accueil",
},

  // ===== Alternance =====
alt_commerce: {
  title: "MÃ©tiers du Commerce en alternance",
  pitch: "Suivre une formation commerciale en alternance entre lâ€™Ã©cole et lâ€™entreprise pour apprendre en pratiquant.",
  duration: "Variable selon la formation et le contrat en entreprise",
  learn: [
    "DÃ©couvrir les techniques de vente directement en entreprise",
    "Appliquer ce que tu apprends en cours au sein dâ€™une Ã©quipe professionnelle",
    "Accompagner les clients et gÃ©rer des missions concrÃ¨tes",
    "DÃ©velopper des compÃ©tences commerciales et relationnelles"
  ],
  jobs: [
    "Vendeur(se) en commerce",
    "Assistant(e) commercial(e)",
    "Conseiller(Ã¨re) de clientÃ¨le"
  ],
  next: "Lâ€™alternance peut se faire dÃ¨s la 1re ou au cours dâ€™une formation commerciale (CAP, Bac Pro ou autre diplÃ´me), en fonction des accords avec une entreprise.",
  pageUrl: "https://lp-aime-cesaire-lille.59.ac-lille.fr/metiers-du-commerce-en-alternance/",
  mode: "alternance",
  family: "commerce",
},
alt_elec: {
  title: "MÃ©tiers de lâ€™Ã‰lectricitÃ© en alternance",
  pitch: "Apprendre le mÃ©tier dâ€™Ã©lectricien en alternant cours au lycÃ©e et travail dans une entreprise.",
  duration: "Variable selon contrat et formation",
  learn: [
    "DÃ©couvrir et pratiquer lâ€™installation Ã©lectrique dans des situations rÃ©elles",
    "Appliquer directement en entreprise ce qui est appris en cours",
    "Travailler sur des circuits, installations et Ã©quipements Ã©lectriques",
    "DÃ©velopper des compÃ©tences techniques recherchÃ©es",
    "Comprendre les normes de sÃ©curitÃ© et qualitÃ©"
  ],
  jobs: [
    "Ã‰lectricien(ne) du bÃ¢timent",
    "Technicien(ne) Ã©lectricien(ne)",
    "Monteur(se) en installations Ã©lectriques"
  ],
  next: "Lâ€™alternance peut se faire Ã  diffÃ©rents niveaux de formation (CAP, Bac Proâ€¦) en accord avec une entreprise.",
  pageUrl: "https://lp-aime-cesaire-lille.59.ac-lille.fr/les-metiers-de-lelectricite/",
  mode: "alternance",
  family: "Ã©lectricitÃ©",
},

alt_metallerie: {
  title: "MÃ©tiers de la MÃ©tallerie en alternance",
  pitch: "DÃ©couvrir les mÃ©tiers de la mÃ©tallerie en alternant formation au lycÃ©e et missions en entreprise.",
  duration: "Variable selon contrat et niveau de formation",
  learn: [
    "Appliquer les techniques de fabrication mÃ©tallique en atelier",
    "Participer Ã  des projets concrets en entreprise",
    "Assembler, souder et faÃ§onner des piÃ¨ces mÃ©talliques",
    "Travailler la mÃ©tallerie pour le bÃ¢timent et lâ€™industrie",
    "DÃ©velopper des compÃ©tences techniques professionnelles"
  ],
  jobs: [
    "MÃ©tallier(Ã¨re)",
    "Serrurier(Ã¨re) mÃ©tallier(Ã¨re)",
    "Ouvrier(Ã¨re) en ouvrages mÃ©talliques"
  ],
  next: "Lâ€™alternance peut Ãªtre organisÃ©e Ã  diffÃ©rents moments de la formation (CAP ou Bac Pro) avec une entreprise partenaire.",
  pageUrl: "https://lp-aime-cesaire-lille.59.ac-lille.fr/les-metiers-de-la-metallerie/",
  mode: "alternance",
  family: "bÃ¢timent",
}
};

/* =========================
   2) Texte "C'est quoi l'alternance ?"
   ========================= */
const ALTERNANCE_EXPLAIN = [
  "ðŸ”„ L'alternance, c'est apprendre un mÃ©tier en travaillant.",
  "",
  "ðŸ‘‰ Une partie du temps au lycÃ©e",
  "ðŸ‘‰ Une partie du temps en entreprise",
  "",
  "âœ… Tu apprends sur le terrain",
  "âœ… Tu gagnes de l'expÃ©rience",
  "âœ… Tu peux Ãªtre rÃ©munÃ©rÃ©(e) selon le contrat",
].join("\n");

/* =========================
   3) MOTS-CLÃ‰S ET RÃ‰PONSES VARIÃ‰ES (CORRIGÃ‰)
   ========================= */
const KEYWORDS = {
  // Salutations
  salut: { 
    replies: [
      "Salut ðŸ‘‹ Bienvenue au lycÃ©e AimÃ© CÃ©saire !",
      "Bonjour ! Je suis lÃ  pour t'orienter ðŸ˜Š",
      "Hey ! PrÃªt(e) Ã  dÃ©couvrir nos formations ?",
      "Salut ! Je suis le chatbot d'orientation du lycÃ©e."
    ],
    next: "start",
    isGreeting: true 
  },
  bonjour: { 
    replies: [
      "Bonjour ! Bienvenue au lycÃ©e AimÃ© CÃ©saire ðŸ‘‹",
      "Bonjour ! Tu cherches une formation ?",
      "Salut ! Je suis lÃ  pour t'aider Ã  t'orienter."
    ], 
    next: "start",
    isGreeting: true 
  },
  hello: { 
    replies: [
      "Hello ! Welcome to AimÃ© CÃ©saire high school ðŸ‘‹",
      "Hi there ! How can I help you ?",
    ], 
    next: "start",
    isGreeting: true 
  },

  // Ã‰LECTRICITÃ‰
  electricite: { 
    replies: [
      "ðŸ”Œ L'Ã©lectricitÃ©, bon choix ! On propose un CAP (2 ans) et un Bac Pro MELEC (3 ans). Tu prÃ©fÃ¨res lequel ?",
      "âš¡ GÃ©nial ! En Ã©lectricitÃ©, tu as le CAP pour entrer vite dans le mÃ©tier, ou le Bac Pro pour aller plus loin.",
      "ðŸ”§ L'Ã©lectricitÃ© t'intÃ©resse ? CAP ou Bac Pro ?",
      "ðŸ’¡ L'Ã©lectricitÃ©, un secteur qui recrute ! Formation courte ou longue ?"
    ],
    next: "elec_choice"
  },
  elec: { 
    replies: [
      "ðŸ”Œ L'Ã©lectricitÃ©, top ! CAP ou Bac Pro ?",
      "âš¡ Tu veux en savoir plus sur l'Ã©lectricitÃ© ? CAP ou Bac Pro ?"
    ],
    next: "elec_choice" 
  },

  // MÃ‰TALLERIE
  metallerie: { 
    replies: [
      "ðŸ§± La mÃ©tallerie, super choix ! CAP (2 ans) ou Bac Pro (3 ans) ?",
      "ðŸ—ï¸ La mÃ©tallerie, c'est prÃ©cis et crÃ©atif. Tu prÃ©fÃ¨res le CAP pratique ou le Bac Pro ?",
      "ðŸ”¨ MÃ©tallerie : CAP pour les bases, Bac Pro pour maÃ®triser les plans complexes.",
      "âš™ï¸ Un mÃ©tier d'art ! Formation courte ou approfondie ?"
    ],
    next: "metal_choice" 
  },
  metal: { 
    replies: [
      "ðŸ§± MÃ©tallerie ! CAP ou Bac Pro ?",
      "ðŸ”¨ Tu veux dÃ©couvrir la mÃ©tallerie ? CAP ou Bac Pro ?"
    ],
    next: "metal_choice" 
  },

  // COMMERCE
  commerce: { 
    replies: [
      "ðŸ›ï¸ Le commerce, excellent ! CAP, 2nde MRC ou Bac Pro Vente ?",
      "ðŸ’¬ Tu veux travailler dans la vente ? On a trois parcours : CAP (2 ans), 2nde MRC (dÃ©couverte) ou Bac Pro (3 ans).",
      "ðŸ§º Commerce : CAP Ã‰quipier, 2nde MRC ou Bac Pro Commerce/Vente ?",
      "ðŸ›’ Formation rapide, dÃ©couverte ou approfondie ?"
    ],
    next: "commerce_choice" 
  },
  vente: { 
    replies: [
      "ðŸ’¬ La vente, super ! CAP, 2nde MRC ou Bac Pro ?",
      "ðŸ›ï¸ Tu veux faire de la vente ? CAP, 2nde ou Bac Pro ?"
    ],
    next: "commerce_choice" 
  },

  // GESTION
  gestion: { 
    replies: [
      "ðŸ“ La gestion administrative, parfait ! Bac Pro AGOrA en 3 ans, avec une 2nde GATL pour dÃ©marrer.",
      "ðŸ—‚ï¸ Gestion/administration : le Bac Pro AGOrA forme aux mÃ©tiers d'assistant(e). 2nde GATL puis spÃ©cialisation.",
      "ðŸ“Š Tu veux travailler dans l'administration ? Bac Pro AGOrA, formation complÃ¨te !",
      "ðŸ“‹ Assistant de gestion, Ã§a te parle ? Bac Pro AGOrA au lycÃ©e !"
    ],
    next: "result_bac_agora" 
  },
  agora: { 
    replies: [
      "ðŸ“ Bac Pro AGOrA : gestion, administration, organisation. Tu commences en 2nde GATL !",
      "ðŸ“Š AGOrA, excellent choix ! Formation complÃ¨te en gestion d'entreprise."
    ],
    next: "result_bac_agora" 
  },
  gatll: { 
    replies: [
      "ðŸ“ 2nde GATL : la porte d'entrÃ©e vers le Bac Pro AGOrA !",
      "ðŸŽ¯ 2nde GATL = dÃ©couverte de la gestion, administration, transport et logistique."
    ],
    next: "result_bac_agora" 
  },

  // ACCUEIL
  accueil: { 
    replies: [
      "ðŸ™‚ L'accueil, un mÃ©tier de contact ! Bac Pro MÃ©tiers de l'Accueil en 3 ans.",
      "ðŸ‘‹ Accueil relation client : formation complÃ¨te pour devenir agent d'accueil.",
      "ðŸ˜Š Tu as le contact ? Le Bac Pro Accueil est fait pour toi !",
      "ðŸ“ž Accueil physique et tÃ©lÃ©phonique, un Bac Pro qui mÃ¨ne Ã  l'emploi."
    ],
    next: "result_bac_accueil" 
  },

  // ALTERNANCE
  alternance: { 
    replies: [
      "ðŸ”„ L'alternance, c'est apprendre en entreprise ! On propose Ã§a en Ã©lectricitÃ©, mÃ©tallerie et commerce.",
      "ðŸ’¼ Alternance = 2 jours au lycÃ©e, 3 jours en entreprise. Quel secteur ?",
      "ðŸ“… L'alternance te tente ? Ã‰lectricitÃ©, mÃ©tallerie ou commerce ?",
      "ðŸ” Formation en alternance : expÃ©rience garantie ! Ã‰lec, mÃ©tal ou commerce ?"
    ],
    next: "alternance_choice" 
  },

  // CAP - GARDER LE CONTEXTE
  cap_elec: {
    replies: [
      "ðŸŽ“ CAP Ã‰lectricien, excellent choix ! Formation en 2 ans pour devenir Ã©lectricien(ne) installateur(trice).",
      "âœ… Le CAP Ã‰lectricien, c'est concret ! Tu seras opÃ©rationnel(le) rapidement."
    ],
    next: "result_cap_elec"
  },
  cap_metal: {
    replies: [
      "ðŸŽ“ CAP MÃ©tallier, super ! Formation en 2 ans pour maÃ®triser les bases du mÃ©tier.",
      "âœ… Le CAP MÃ©tallier, c'est pratique et prÃ©cis ! Tu apprendras Ã  fabriquer garde-corps, portails..."
    ],
    next: "result_cap_metallier"
  },
  cap_commerce: {
    replies: [
      "ðŸŽ“ CAP Ã‰quipier Polyvalent du Commerce, parfait ! Formation en 2 ans pour travailler en magasin.",
      "âœ… Le CAP Commerce, c'est la voie rapide pour devenir employÃ©(e) de commerce."
    ],
    next: "result_cap_epc"
  },

  // BAC PRO - GARDER LE CONTEXTE
  bac_elec: {
    replies: [
      "ðŸ“ˆ Bac Pro MELEC, top ! Formation en 3 ans pour devenir technicien(ne) Ã©lectricien(ne).",
      "ðŸŽ¯ Le Bac Pro Ã‰lectricitÃ©, c'est plus complet ! Tu pourras Ã©voluer vers des postes Ã  responsabilitÃ©s."
    ],
    next: "result_bac_melec"
  },
  bac_metal: {
    replies: [
      "ðŸ“ˆ Bac Pro MÃ©tallerie, excellent ! Formation en 3 ans pour maÃ®triser les ouvrages complexes.",
      "ðŸŽ¯ Le Bac Pro MÃ©tallerie ouvre plus de portes ! BTS possible aprÃ¨s."
    ],
    next: "result_bac_metallerie"
  },
  bac_commerce: {
    replies: [
      "ðŸ“ˆ Bac Pro Commerce/Vente, super ! Formation en 3 ans pour devenir vendeur(se) conseil.",
      "ðŸŽ¯ Le Bac Pro Commerce, c'est la voie pour Ã©voluer vers des postes de management."
    ],
    next: "result_bac_commerce_vente"
  },

  // RÃ‰PONSES SPÃ‰CIFIQUES
  cap: { 
    replies: [], // Ne plus utiliser, gÃ©rÃ© par les contextes spÃ©cifiques
    next: null 
  },
  bacpro: { 
    replies: [], // Ne plus utiliser, gÃ©rÃ© par les contextes spÃ©cifiques
    next: null 
  },

  // Remerciements
  merci: { 
    replies: [
      "Avec plaisir ! ðŸ‘‹",
      "De rien ! Reviens quand tu veux ðŸ˜Š",
      "Service ! N'hÃ©site pas Ã  recommencer ðŸš€",
      "ðŸ˜„ Contente d'avoir pu t'aider !",
      "ðŸ‘ Bonne continuation !"
    ],
    next: null 
  },

  // Au revoir
  aurevoir: { 
    replies: [
      "Ã€ bientÃ´t ! ðŸ‘‹",
      "Salut ! Bonne continuation ðŸš€",
      "Bye ! Reviens tester d'autres formations ðŸ˜Š",
      "ðŸ‘‹ N'hÃ©site pas Ã  revenir !",
      "Bonne journÃ©e !"
    ],
    next: null 
  },

  // Aide
  aide: {
    replies: [
      "ðŸ¤– Je suis lÃ  pour t'orienter ! Tu peux me parler d'Ã©lectricitÃ©, mÃ©tallerie, commerce, gestion, accueil ou alternance.",
      "ðŸ’¡ Ã‰cris un mÃ©tier ou une formation : CAP Ã©lectricien, Bac Pro commerce, alternance...",
      "ðŸ” Tu cherches quoi ? Ã‰lectricitÃ©, mÃ©tallerie, commerce, gestion, accueil ?"
    ],
    next: "start"
  }
};

/* =========================
   4) ARBRE PRINCIPAL (FLOW)
   ========================= */
/* =========================
   4) ARBRE PRINCIPAL (FLOW) - CORRIGÃ‰
   ========================= */
const FLOW = {
  start: {
    bot: [
      "Salut ðŸ‘‹ Je suis le chatbot d'orientation du lycÃ©e AimÃ© CÃ©saire.\nJe suis conÃ§u par les Ã©lÃ¨ves du lycÃ©e, pour les futurs Ã©lÃ¨ves du lycÃ©e.\n\nEn quelques clics, je t'aide Ã  dÃ©couvrir une formation et un mÃ©tier.\nPrÃªt(e) ? ðŸš€\n\nTu t'intÃ©resses plutÃ´t Ã  :",
      "Bonjour ! ðŸ‘‹ Je suis le chatbot du lycÃ©e AimÃ© CÃ©saire.\nJe suis lÃ  pour t'aider Ã  trouver la formation qui te correspond.\n\nTu veux dÃ©couvrir l'Ã©lectricitÃ©, la mÃ©tallerie, le commerce, la gestion ou l'accueil ?",
      "Salut ! ðŸ¤–\nBienvenue au lycÃ©e AimÃ© CÃ©saire.\n\nDis-moi ce qui t'intÃ©resse : Ã©lectricitÃ©, mÃ©tallerie, commerce, gestion, accueil...",
      "HÃ© ! ðŸ‘‹\nJe suis le chatbot d'orientation du lycÃ©e.\nConÃ§u par des Ã©lÃ¨ves, pour des Ã©lÃ¨ves.\n\nTu cherches une formation dans quel domaine ?"
    ],
    replies: [] // Pas de boutons au dÃ©but
  },

  // Ã‰LECTRICITÃ‰
  elec_choice: {
    bot: "ðŸ”Œ Ã‰lectricitÃ© : CAP ou Bac Pro ?",
    replies: [
      { label: "ðŸŽ“ CAP Ã‰lectricien (2 ans)", value: "cap_elec" },
      { label: "ðŸ“ˆ Bac Pro MELEC (3 ans)", value: "bac_melec" },
      { label: "ðŸ”„ Alternance", value: "alt_elec" },
      //{ label: "ðŸ”™ Retour", value: "back" },
    ],
    next: (ans) => {
      if (ans === "cap_elec") return "result_cap_elec";
      if (ans === "bac_melec") return "result_bac_melec";
      if (ans === "alt_elec") return "result_alt_elec";
      return "start";
    },
  },

  // MÃ‰TALLERIE
  metal_choice: {
    bot: "ðŸ§± MÃ©tallerie : CAP ou Bac Pro ?",
    replies: [
      { label: "ðŸŽ“ CAP MÃ©tallier (2 ans)", value: "cap_metal" },
      { label: "ðŸ“ˆ Bac Pro MÃ©tallerie (3 ans)", value: "bac_metal" },
      { label: "ðŸ”„ Alternance", value: "alt_metal" },
      //{ label: "ðŸ”™ Retour", value: "back" },
    ],
    next: (ans) => {
      if (ans === "cap_metal") return "result_cap_metallier";
      if (ans === "bac_metal") return "result_bac_metallerie";
      if (ans === "alt_metal") return "result_alt_metallerie";
      return "start";
    },
  },

  // COMMERCE
  commerce_choice: {
    bot: "ðŸ›ï¸ Commerce : quelle voie ?",
    replies: [
      { label: "ðŸŽ“ CAP Ã‰quipier Polyvalent", value: "cap_commerce" },
      { label: "ðŸ§­ 2nde MRC (dÃ©couverte)", value: "seconde_mrc" },
      { label: "ðŸ“ˆ Bac Pro Commerce/Vente", value: "bac_commerce" },
      { label: "ðŸ”„ Alternance", value: "alt_commerce" },
      //{ label: "ðŸ”™ Retour", value: "back" },
    ],
    next: (ans) => {
      if (ans === "cap_commerce") return "result_cap_epc";
      if (ans === "seconde_mrc") return "result_seconde_mrc";
      if (ans === "bac_commerce") return "result_bac_commerce_vente";
      if (ans === "alt_commerce") return "result_alt_commerce";
      return "start";
    },
  },

  // ALTERNANCE
  alternance_choice: {
    bot: "ðŸ”„ Alternance disponible en :\nâ€¢ Ã‰lectricitÃ©\nâ€¢ MÃ©tallerie\nâ€¢ Commerce\n\nTu veux quel secteur ?",
    replies: [
      { label: "âš¡ Ã‰lectricitÃ©", value: "alt_elec" },
      { label: "ðŸ§± MÃ©tallerie", value: "alt_metal" },
      { label: "ðŸ›ï¸ Commerce", value: "alt_commerce" },
      //{ label: "ðŸ”™ Retour", value: "back" },
    ],
    next: (ans) => {
      if (ans === "alt_elec") return "result_alt_elec";
      if (ans === "alt_metal") return "result_alt_metallerie";
      if (ans === "alt_commerce") return "result_alt_commerce";
      return "start";
    },
  },

  // CHOIX CAP
  cap_choice: {
    bot: "ðŸŽ“ CAP disponible en :\nâ€¢ Ã‰lectricitÃ©\nâ€¢ MÃ©tallerie\nâ€¢ Commerce\n\nTu prÃ©fÃ¨res lequel ?",
    replies: [
      { label: "âš¡ CAP Ã‰lectricien", value: "cap_elec" },
      { label: "ðŸ§± CAP MÃ©tallier", value: "cap_metal" },
      { label: "ðŸ›ï¸ CAP Commerce", value: "cap_commerce" },
      //{ label: "ðŸ”™ Retour", value: "back" },
    ],
    next: (ans) => {
      if (ans === "cap_elec") return "result_cap_elec";
      if (ans === "cap_metal") return "result_cap_metallier";
      if (ans === "cap_commerce") return "result_cap_epc";
      return "start";
    },
  },

  // CHOIX BAC PRO
  bac_choice: {
    bot: "ðŸ“ˆ Bac Pro disponible en :\nâ€¢ Ã‰lectricitÃ© (MELEC)\nâ€¢ MÃ©tallerie\nâ€¢ Commerce/Vente\nâ€¢ Gestion (AGOrA)\nâ€¢ Accueil\n\nLequel te tente ?",
    replies: [
      { label: "âš¡ MELEC", value: "bac_melec" },
      { label: "ðŸ§± MÃ©tallerie", value: "bac_metal" },
      { label: "ðŸ›ï¸ Commerce/Vente", value: "bac_commerce" },
      { label: "ðŸ“ AGOrA", value: "agora" },
      { label: "ðŸ™‚ Accueil", value: "accueil" },
      //{ label: "ðŸ”™ Retour", value: "back" },
    ],
    next: (ans) => {
      if (ans === "bac_melec") return "result_bac_melec";
      if (ans === "bac_metal") return "result_bac_metallerie";
      if (ans === "bac_commerce") return "result_bac_commerce_vente";
      if (ans === "agora") return "result_bac_agora";
      if (ans === "accueil") return "result_bac_accueil";
      return "start";
    },
  },

  // ----- RÃ‰SULTATS (avec cartes) -----
  result_cap_elec: { result: ["cap_elec"] },
  result_bac_melec: { result: ["bac_melec"] },
  result_cap_metallier: { result: ["cap_metallier"] },
  result_bac_metallerie: { result: ["bac_metallerie"] },
  result_cap_epc: { result: ["cap_epc"] },
  result_seconde_mrc: { result: ["seconde_mrc"] },
  result_bac_commerce_vente: { result: ["bac_commerce_vente"] },
  result_bac_agora: { result: ["bac_agora"] },
  result_bac_accueil: { result: ["bac_accueil"] },
  result_alt_commerce: { result: ["alt_commerce"] },
  result_alt_elec: { result: ["alt_elec"] },
  result_alt_metallerie: { result: ["alt_metallerie"] },
};


/* =========================
   5) Ã‰tat + helpers
   ========================= */
let state = { nodeId: "start", history: [] };
let demoTimer = null;

function nowTime() {
  const d = new Date();
  return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
}
function scrollToBottom() {
  mainEl.scrollTop = mainEl.scrollHeight;
}
function setStatus(text) {
  statusChip.textContent = text;
}

/* =========================
   6) Messages (UI)
   ========================= */
function addMessage({ from, text, html }) {
  const row = document.createElement("div");
  row.className = "row " + (from === "bot" ? "bot" : "user");

  if (from === "bot") {
    const av = document.createElement("div");
    av.className = "avatar";
    av.textContent = "ðŸ¤–";
    row.appendChild(av);
  }

  const bubble = document.createElement("div");
  bubble.className = "bubble";
  if (html) bubble.innerHTML = html;
  else bubble.textContent = text;

  const meta = document.createElement("div");
  meta.className = "meta";
  meta.textContent = nowTime();

  if (from === "user") {
    row.appendChild(meta);
    row.appendChild(bubble);
  } else {
    row.appendChild(bubble);
    row.appendChild(meta);
  }

  messagesEl.appendChild(row);
  scrollToBottom();
}

function addTyping() {
  const row = document.createElement("div");
  row.className = "row bot";
  row.dataset.typing = "1";

  const av = document.createElement("div");
  av.className = "avatar";
  av.textContent = "ðŸ¤–";

  const bubble = document.createElement("div");
  bubble.className = "bubble";
  bubble.innerHTML = `<span class="typing" aria-label="Le bot Ã©crit">
      <span class="dot"></span><span class="dot"></span><span class="dot"></span>
    </span>`;

  row.appendChild(av);
  row.appendChild(bubble);
  messagesEl.appendChild(row);
  scrollToBottom();
}
function removeTyping() {
  const t = messagesEl.querySelector('[data-typing="1"]');
  if (t) t.remove();
}

/* =========================
   7) Effet ChatGPT : mot par mot
   ========================= */
function escapeHtml(str) {
  return str
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function typewriterMessage(text, { speed = 60, onComplete } = {}) {
  setStatus("Ã‰critâ€¦");
  quickRepliesEl.style.display = "none";

  const row = document.createElement("div");
  row.className = "row bot";

  const av = document.createElement("div");
  av.className = "avatar";
  av.textContent = "ðŸ¤–";

  const bubble = document.createElement("div");
  bubble.className = "bubble";
  bubble.textContent = "";

  const meta = document.createElement("div");
  meta.className = "meta";
  meta.textContent = nowTime();

  row.appendChild(av);
  row.appendChild(bubble);
  row.appendChild(meta);
  messagesEl.appendChild(row);
  scrollToBottom();

  const safe = escapeHtml(text);
  const parts = safe.split(/(\s+)/);
  let i = 0;

  const timer = setInterval(() => {
    bubble.innerHTML += parts[i] ?? "";
    i++;
    scrollToBottom();
    if (i >= parts.length) {
      clearInterval(timer);
      setStatus("PrÃªt");
      quickRepliesEl.style.display = "flex";
      if (onComplete) onComplete();
    }
  }, speed);
}

function botSay(textOrHtml, { html = false, speed = 60, onComplete } = {}) {
  if (html) {
    setStatus("RÃ©pondâ€¦");
    quickRepliesEl.style.display = "none";
    addTyping();
    
    const delay = 300 + Math.random() * 200;
    window.setTimeout(() => {
      removeTyping();
      addMessage({ from: "bot", html: textOrHtml });
      setStatus("PrÃªt");
      quickRepliesEl.style.display = "flex";
      if (onComplete) onComplete();
    }, delay);
    return;
  }

  quickRepliesEl.style.display = "none";
  addTyping();
  
  const delay = 200 + Math.random() * 150;
  window.setTimeout(() => {
    removeTyping();
    typewriterMessage(textOrHtml, { speed, onComplete });
  }, delay);
}

/* =========================
   8) RÃ‰PONSES ALÃ‰ATOIRES
   ========================= */
function getRandomReply(keyword) {
  const keywordData = KEYWORDS[keyword];
  if (keywordData && keywordData.replies) {
    const randomIndex = Math.floor(Math.random() * keywordData.replies.length);
    return keywordData.replies[randomIndex];
  }
  return null;
}

/* =========================
   9) GESTION DU TEXTE LIBRE (CORRIGÃ‰)
   ========================= */
function handleUserInput(inputText) {
  const text = inputText.toLowerCase().trim();
  
  // Ignorer si vide
  if (!text) return null;
  
  // VÃ©rifier les salutations
  if (text.includes("salut") || text.includes("bonjour") || text.includes("hello") || text === "bjr" || text === "slt") {
    return { type: "greeting", keyword: "salut" };
  }
  
  if (text.includes("merci") || text.includes("thanks") || text.includes("thank")) {
    return { type: "reply", keyword: "merci" };
  }
  
  if (text.includes("au revoir") || text.includes("bye") || text.includes("ciao") || text.includes("a+") || text.includes("Ã  plus")) {
    return { type: "reply", keyword: "aurevoir" };
  }

  if (text.includes("aide") || text.includes("help") || text.includes("quoi") || text.includes("comment")) {
    return { type: "reply", keyword: "aide" };
  }

  // === GESTION DU CONTEXTE ===
  // Si on est dans un choix spÃ©cifique, prioritÃ© au contexte
  const currentNode = state.nodeId;
  
  // Si on est dans le choix Ã©lectricitÃ©
  if (currentNode === "elec_choice") {
    if (text.includes("cap")) {
      return { type: "flow", keyword: "cap_elec" };
    }
    if (text.includes("bac") || text.includes("bacpro") || text.includes("bac pro") || text.includes("melec")) {
      return { type: "flow", keyword: "bac_elec" };
    }
    if (text.includes("alternance") || text.includes("alt")) {
      return { type: "flow", keyword: "alternance", context: "elec" };
    }
  }
  
  // Si on est dans le choix mÃ©tallerie
  if (currentNode === "metal_choice") {
    if (text.includes("cap")) {
      return { type: "flow", keyword: "cap_metal" };
    }
    if (text.includes("bac") || text.includes("bacpro") || text.includes("bac pro")) {
      return { type: "flow", keyword: "bac_metal" };
    }
    if (text.includes("alternance") || text.includes("alt")) {
      return { type: "flow", keyword: "alternance", context: "metal" };
    }
  }
  
  // Si on est dans le choix commerce
  if (currentNode === "commerce_choice") {
    if (text.includes("cap")) {
      return { type: "flow", keyword: "cap_commerce" };
    }
    if (text.includes("2nde") || text.includes("mrc") || text.includes("seconde")) {
      return { type: "flow", keyword: "seconde_mrc" };
    }
    if (text.includes("bac") || text.includes("bacpro") || text.includes("bac pro") || text.includes("vente")) {
      return { type: "flow", keyword: "bac_commerce" };
    }
    if (text.includes("alternance") || text.includes("alt")) {
      return { type: "flow", keyword: "alternance", context: "commerce" };
    }
  }

  // === RECHERCHE DE MOTS-CLÃ‰S PAR PRIORITÃ‰ ===
  
  // 1. Mots-clÃ©s spÃ©cifiques avec contexte (CAP + domaine)
  if (text.includes("cap") && text.includes("elec")) {
    return { type: "flow", keyword: "cap_elec" };
  }
  if (text.includes("cap") && (text.includes("metal") || text.includes("mÃ©tal"))) {
    return { type: "flow", keyword: "cap_metal" };
  }
  if (text.includes("cap") && (text.includes("commerce") || text.includes("vente"))) {
    return { type: "flow", keyword: "cap_commerce" };
  }
  
  if ((text.includes("bac") || text.includes("bacpro")) && text.includes("elec")) {
    return { type: "flow", keyword: "bac_elec" };
  }
  if ((text.includes("bac") || text.includes("bacpro")) && (text.includes("metal") || text.includes("mÃ©tal"))) {
    return { type: "flow", keyword: "bac_metal" };
  }
  if ((text.includes("bac") || text.includes("bacpro")) && (text.includes("commerce") || text.includes("vente"))) {
    return { type: "flow", keyword: "bac_commerce" };
  }
  if ((text.includes("bac") || text.includes("bacpro")) && (text.includes("gestion") || text.includes("agora"))) {
    return { type: "flow", keyword: "gestion" };
  }
  if ((text.includes("bac") || text.includes("bacpro")) && text.includes("accueil")) {
    return { type: "flow", keyword: "accueil" };
  }

  // 2. Domaines principaux
  if (text.includes("electricite") || text.includes("elec") || text.includes("Ã©lectricitÃ©") || text.includes("Ã©lectricien")) {
    return { type: "flow", keyword: "electricite" };
  }
  
  if (text.includes("metallerie") || text.includes("metal") || text.includes("mÃ©tallerie") || text.includes("serrurier") || text.includes("mÃ©tal")) {
    return { type: "flow", keyword: "metallerie" };
  }
  
  if (text.includes("commerce") || text.includes("vente") || text.includes("magasin") || text.includes("rayon") || text.includes("vendeur")) {
    return { type: "flow", keyword: "commerce" };
  }
  
  if (text.includes("gestion") || text.includes("agora") || text.includes("gatll") || text.includes("administration") || text.includes("assistant")) {
    return { type: "flow", keyword: "gestion" };
  }
  
  if (text.includes("accueil") || text.includes("acceuil") || text.includes("hotesse") || text.includes("hÃ´tesse")) {
    return { type: "flow", keyword: "accueil" };
  }
  
  if (text.includes("alternance") || text.includes("alterner") || text.includes("apprentissage") || text.includes("contrat")) {
    return { type: "flow", keyword: "alternance" };
  }
  
  // 3. CAP et Bac Pro sans contexte â†’ demander le domaine
  if (text.includes("cap") && !text.includes("bac")) {
    return { 
      type: "unknown", 
      text: "ðŸŽ“ CAP dans quel domaine ? On propose :\nâ€¢ Ã‰lectricitÃ©\nâ€¢ MÃ©tallerie\nâ€¢ Commerce" 
    };
  }
  
  if ((text.includes("bac") || text.includes("bacpro")) && !text.includes("cap")) {
    return { 
      type: "unknown", 
      text: "ðŸ“ˆ Bac Pro dans quel domaine ? On propose :\nâ€¢ Ã‰lectricitÃ© (MELEC)\nâ€¢ MÃ©tallerie\nâ€¢ Commerce/Vente\nâ€¢ Gestion (AGOrA)\nâ€¢ Accueil" 
    };
  }
  
  // Aucun mot-clÃ© trouvÃ©
  return { 
    type: "unknown", 
    text: "ðŸ¤” Je n'ai pas bien compris. Tu peux Ã©crire :\nâ€¢ Ã‰lectricitÃ©\nâ€¢ MÃ©tallerie\nâ€¢ Commerce\nâ€¢ Gestion (AGOrA)\nâ€¢ Accueil\nâ€¢ Alternance\n\nOu directement : CAP Ã©lectricien, Bac Pro commerce..." 
  };
}
/* =========================
   10) Quick replies (boutons)
   ========================= */
function setReplies(replies) {
  quickRepliesEl.innerHTML = "";

  (replies || []).forEach((r, idx) => {
    const b = document.createElement("button");
    b.className = "qr " + (idx === 0 ? "accent" : idx === 1 ? "good" : "");
    b.textContent = r.label;
    b.onclick = () => onUserAnswer(r);
    quickRepliesEl.appendChild(b);
  });

  // Bouton "C'est quoi l'alternance ?" SEULEMENT aprÃ¨s un rÃ©sultat d'alternance
  const nodeId = state.nodeId;
  if (nodeId.startsWith('result_alt_')) {
    const alt = document.createElement("button");
    alt.className = "qr";
    alt.textContent = "â„¹ï¸ C'est quoi l'alternance ?";
    alt.onclick = () => showAlternanceInfo();
    quickRepliesEl.appendChild(alt);
  }

  // Bouton restart
  /*const restart = document.createElement("button");
  restart.className = "qr warn";
  restart.textContent = "â†º Recommencer";
  restart.onclick = restartFlow;
  quickRepliesEl.appendChild(restart);*/
}

/* =========================
   11) Cartes rÃ©sultats
   ========================= */
function renderResultCards(keys) {
  const cards = keys
    .map((k) => {
      const p = PROGRAMS[k];

      const jobs = (p.jobs || [])
        .map((j) => `â€¢ ${escapeHtml(j)}`)
        .join("<br>");

      const learn = (p.learn || [])
        .map((l) => `â€¢ ${escapeHtml(l)}`)
        .join("<br>");

      return `
      <div class="card">
        ${p.badge ? `<div class="badge">${escapeHtml(p.badge)}</div>` : ""}
        
        <h3>${escapeHtml(p.title)}</h3>
        
        <p>${escapeHtml(p.pitch)}</p>
        
        ${p.duration ? `<p><strong>DurÃ©e :</strong> ${escapeHtml(p.duration)}</p>` : ""}
        
        ${learn ? `<p><strong>Tu apprendras Ã  :</strong><br>${learn}</p>` : ""}
        
        <p><strong>Exemples de mÃ©tiers :</strong><br>${jobs}</p>
        
        <p>${escapeHtml(p.next)}</p>
        
        ${
          p.pageUrl
            ? `<div class="actions">
                <a class="link" href="${p.pageUrl}" target="_blank" rel="noopener">ðŸ“„ Page formation </a>
              </div>`
            : ""
        }
      </div>
    `;
    })
    .join("");

  return `
    <div>
      <div style="margin-bottom:10px; font-weight:800;">Voici ce que je te propose ðŸ‘‡</div>
      <div class="cards">${cards}</div>
      <div style="margin-top:10px; color: rgba(255,255,255,.70); font-size:13px;">
        Tu peux recommencer pour tester un autre profil.
      </div>
    </div>
  `;
}


/* =========================
   12) Navigation (CORRIGÃ‰)
   ========================= */
function goTo(nodeId) {
  state.nodeId = nodeId;
  const node = FLOW[nodeId];

  // RÃ©sultat ? -> Affiche les cartes de formation
  if (node.result) {
    botSay("Je rÃ©flÃ©chis Ã  la meilleure formation pour toiâ€¦", {
      speed: 40,
      onComplete: () => {
        const html = renderResultCards(node.result);
        botSay(html, { 
          html: true,
          onComplete: () => {
            setReplies([
              { label: "ðŸ” Refaire le test", value: "__restart__" },
              //{ label: "ðŸ§­ Voir toutes les formations", value: "__all__" },
            ]);
          }
        });
      }
    });
    return;
  }

  // Question normale - avec effet d'Ã©criture
  const botMessage = Array.isArray(node.bot) ? getRandomArrayItem(node.bot) : node.bot;
  
  if (node.replies && node.replies.length > 0) {
    // S'il y a des boutons, on les affiche aprÃ¨s l'effet d'Ã©criture
    botSay(botMessage, {
      speed: 50,
      onComplete: () => {
        setReplies(node.replies);
      }
    });
  } else {
    // Pas de boutons (ex: start)
    botSay(botMessage, {
      speed: 50,
      onComplete: () => {}
    });
  }
}


/* =========================
   13) Gestion des rÃ©ponses utilisateur (CORRIGÃ‰)
   ========================= */
function onUserAnswer(reply) {
  quickRepliesEl.style.display = "none";
  
  // Actions spÃ©ciales boutons
  if (reply.value === "__restart__") {
    restartFlow();
    return;
  }
  if (reply.value === "__all__") {
    showAllPrograms();
    return;
  }
  if (reply.value === "back") {
    addMessage({ from: "user", text: "ðŸ”™ Retour" });
    goTo("start");
    return;
  }

  // Si c'est un bouton normal
  if (reply.value && !reply.isText) {
    addMessage({ from: "user", text: reply.label });
    
    const current = FLOW[state.nodeId];
    state.history.push({ nodeId: state.nodeId, answer: reply.value });
    
    const nextId = typeof current.next === "function" ? current.next(reply.value) : current.next;
    goTo(nextId);
    return;
  }
  
  // Si c'est du texte libre
  if (reply.isText) {
    addMessage({ from: "user", text: reply.label });
    
    const result = handleUserInput(reply.label);
    
    if (result.type === "greeting") {
      const replyText = getRandomReply("salut");
      botSay(replyText, { speed: 50, onComplete: () => goTo("start") });
    }
    else if (result.type === "reply") {
      const replyText = getRandomReply(result.keyword);
      botSay(replyText, { speed: 50, onComplete: () => {} });
    }
    else if (result.type === "flow") {
      const replyText = getRandomReply(result.keyword);
      
      // DÃ©terminer la prochaine Ã©tape
      let nextNode = "start";
      if (result.keyword === "electricite") nextNode = "elec_choice";
      if (result.keyword === "metallerie") nextNode = "metal_choice";
      if (result.keyword === "commerce") nextNode = "commerce_choice";
      if (result.keyword === "gestion") nextNode = "result_bac_agora";
      if (result.keyword === "accueil") nextNode = "result_bac_accueil";
      if (result.keyword === "alternance") nextNode = "alternance_choice";
      if (result.keyword === "cap_elec") nextNode = "result_cap_elec";
      if (result.keyword === "cap_metal") nextNode = "result_cap_metallier";
      if (result.keyword === "cap_commerce") nextNode = "result_cap_epc";
      if (result.keyword === "bac_elec") nextNode = "result_bac_melec";
      if (result.keyword === "bac_metal") nextNode = "result_bac_metallerie";
      if (result.keyword === "bac_commerce") nextNode = "result_bac_commerce_vente";
      if (result.keyword === "seconde_mrc") nextNode = "result_seconde_mrc";
      
      botSay(replyText, { speed: 50, onComplete: () => goTo(nextNode) });
    }
    else {
      botSay(result.text, { speed: 50, onComplete: () => {} });
    }
  }
}


/* =========================
   14) Actions spÃ©ciales
   ========================= */
function showAlternanceInfo() {
  quickRepliesEl.style.display = "none";
  addMessage({ from: "user", text: "â„¹ï¸ C'est quoi l'alternance ?" });
  botSay(ALTERNANCE_EXPLAIN, {
    onComplete: () => {
      // AprÃ¨s l'explication, remettre les boutons de rÃ©sultat
      const node = FLOW[state.nodeId];
      if (node && node.result) {
        setReplies([
          { label: "ðŸ” Refaire le test", value: "__restart__" },
          { label: "ðŸ§­ Voir toutes les formations", value: "__all__" },
        ]);
      }
    }
  });
}

function showAllPrograms() {
  quickRepliesEl.style.display = "none";
  addMessage({ from: "user", text: "ðŸ§­ Voir toutes les formations" });

  botSay("Voici toutes les formations proposÃ©es au lycÃ©e AimÃ© CÃ©saire.", {
    onComplete: () => {
      const keys = Object.keys(PROGRAMS);
      const html = `
        <div>
          <div style="margin-bottom:10px; font-weight:800;">Toutes les formations ðŸ‘‡</div>
          <div class="cards">
            ${keys
              .map((k) => {
                const p = PROGRAMS[k];
                return `
                <div class="card">
                  <div class="badge">${escapeHtml(p.badge)}</div>
                  <h3>${escapeHtml(p.title)}</h3>
                  <p>${escapeHtml(p.pitch)}</p>
                  <div class="actions">
                    <a class="link" href="${p.pageUrl}" target="_blank" rel="noopener">ðŸ“„ Page formation</a>
                  </div>
                </div>
              `;
              })
              .join("")}
          </div>
        </div>
      `;

      botSay(html, { 
        html: true,
        onComplete: () => {
          setReplies([{ label: "ðŸ” Refaire le test", value: "__restart__" }]);
        }
      });
    }
  });
}


/* =========================
   15) Restart + Intro (CORRIGÃ‰)
   ========================= */
function restartFlow() {
  stopDemo();
  messagesEl.innerHTML = "";
  quickRepliesEl.style.display = "none";
  state = { nodeId: "start", history: [] };
  setStatus("PrÃªt");
  
  // Message d'intro alÃ©atoire - AVEC EFFET D'Ã‰CRITURE
  const startMessages = FLOW["start"].bot;
  const randomMessage = Array.isArray(startMessages) 
    ? startMessages[Math.floor(Math.random() * startMessages.length)]
    : startMessages;
  
  // Utiliser botSay pour l'effet d'Ã©criture
  botSay(randomMessage, {
    speed: 45,
    onComplete: () => {
      // PAS de boutons au dÃ©marrage
      quickRepliesEl.innerHTML = "";
    }
  });
}

function intro() {
  quickRepliesEl.style.display = "none";
  // Attendre un peu puis dÃ©marrer
  setTimeout(() => {
    restartFlow();
  }, 300);
}



// Helper pour choisir un message alÃ©atoire
function getRandomArrayItem(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

/* =========================
   16) INPUT TEXTE LIBRE (NOUVEAU)
   ========================= */

function addTextInput() {
  // Ã©viter doublon
  if (document.querySelector(".text-input-container")) return;

  // hÃ´te fixe pour le composer
  const host = document.getElementById("composerHost");
  if (!host) return;

  const container = document.createElement("div");
  container.className = "text-input-container";
  // âš ï¸ plus besoin de style inline : tu as dÃ©jÃ  le CSS .text-input-container
  // (si tu veux garder un fallback, dÃ©commente ci-dessous)
  /*
  container.style.cssText = `
    display:flex;
    gap:10px;
    padding: 8px 16px 12px 16px;
    width:100%;
    box-sizing:border-box;
    position: sticky;
    bottom: 0;
    z-index: 300;
    background: rgba(10,14,28,.75);
    border-top: 1px solid rgba(255,255,255,.08);
    backdrop-filter: blur(10px);
  `;
  */

  const input = document.createElement("input");
  input.type = "text";
  input.placeholder = "Ã‰cris ta question ici... (Ã©lectricitÃ©, commerce, CAP...)";
  input.autocomplete = "off";
  input.spellcheck = false;
  input.setAttribute("aria-label", "Message");

  const sendBtn = document.createElement("button");
  sendBtn.type = "button";
  sendBtn.textContent = "Envoyer";

  function send() {
    const v = input.value.trim();
    if (!v) return;
    onUserAnswer({ label: v, value: null, isText: true });
    input.value = "";
    input.focus();
  }

  sendBtn.onclick = send;

  // âœ… Enter = envoyer (Shift+Enter = nouvelle ligne si tu passes l'input en textarea plus tard)
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      send();
    }
  });

  container.appendChild(input);
  container.appendChild(sendBtn);

  // âœ… insertion stable tout en bas
  host.appendChild(container);
}
/* =========================
   17) Mode DÃ©mo
   ========================= */
function startDemo() {
  stopDemo();
  btnDemo.textContent = "â¸ Stop dÃ©mo";
  btnDemo.dataset.on = "1";
  restartFlow();

  const script = [
    { wait: 1500, pickIndex: 0 }, // tech
    { wait: 1500, pickIndex: 0 }, // CAP Ã©lec
  ];

  let i = 0;

  function step() {
    if (!btnDemo.dataset.on) return;

    const node = FLOW[state.nodeId];
    if (!node || !node.replies) return;

    const idx = script[i]?.pickIndex ?? 0;
    const r = node.replies[Math.min(idx, node.replies.length - 1)];
    if (!r) return;

    onUserAnswer(r);
    i++;

    if (i < script.length) {
      demoTimer = setTimeout(step, script[i].wait);
    }
  }

  demoTimer = setTimeout(step, script[0].wait);
}

function stopDemo() {
  if (demoTimer) clearTimeout(demoTimer);
  demoTimer = null;
  //btnDemo.textContent = "â–¶ DÃ©mo";
  btnDemo.removeAttribute("data-on");
}

/* =========================
   18) Event Listeners
   ========================= */
btnRestart?.addEventListener("click", restartFlow);
btnDemo?.addEventListener("click", () => {
  if (btnDemo.dataset.on) stopDemo();
  else startDemo();
});

/* =========================
   19) Lancement
   ========================= */
// Attendre que le DOM soit chargÃ©
if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", () => {
    intro();
    setTimeout(addTextInput, 200);
  });
} else {
  intro();
  setTimeout(addTextInput, 200);
}
</script>
</body>
</html>
